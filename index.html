<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Truth Hunters: A research-backed game for middle schoolers to develop epistemic skills, AI error detection, and confidence calibration.">
  <meta name="theme-color" content="#0a0e1a">
  <meta name="color-scheme" content="dark">
  <title>Truth Hunters: The Calibration Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-deep: #0a0e1a;
      --bg-card: #111827;
      --bg-elevated: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #8b9cb8;
      --accent-cyan: #22d3ee;
      --accent-amber: #fbbf24;
      --accent-rose: #fb7185;
      --accent-emerald: #34d399;
      --accent-violet: #a78bfa;
      --confidence-1: #3b82f6;
      --confidence-2: #f59e0b;
      --confidence-3: #ef4444;
      --correct: #10b981;
      --incorrect: #ef4444;
      --border: #334155;
      --font-mono: 'JetBrains Mono', monospace;
      --font-serif: 'Source Serif 4', Georgia, serif;
    }

    html { font-size: 16px; }
    
    body {
      font-family: var(--font-serif);
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(34, 211, 238, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(167, 139, 250, 0.06) 0%, transparent 50%);
    }

    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Utility Classes */
    .mono { font-family: var(--font-mono); }
    .serif { font-family: var(--font-serif); }
    
    /* Animations */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-4px); }
      40%, 80% { transform: translateX(4px); }
    }

    @keyframes celebrate {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .animate-in {
      animation: fadeSlideIn 0.4s ease-out forwards;
    }

    .animate-pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    .animate-shake {
      animation: shake 0.4s ease-in-out;
    }

    .animate-celebrate {
      animation: celebrate 0.3s ease-out;
    }

    /* Badge shimmer animation */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .achievement-badge {
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(251, 191, 36, 0.3) 50%,
        transparent 100%);
      background-size: 200% 100%;
      animation: shimmer 2s ease-in-out infinite;
    }

    /* Streak fire animation */
    @keyframes fireGlow {
      0%, 100% {
        text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        transform: scale(1);
      }
      50% {
        text-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        transform: scale(1.05);
      }
    }

    .streak-fire {
      animation: fireGlow 1s ease-in-out infinite;
    }

    /* Bounce animation for achievements */
    @keyframes bounceIn {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .animate-bounce-in {
      animation: bounceIn 0.4s ease-out forwards;
    }

    /* Chromebook-specific optimizations */
    @media (max-width: 1024px) and (min-resolution: 1dppx) {
      /* Reduce animation complexity for lower-end devices */
      .animate-in {
        animation-duration: 0.2s;
      }

      /* Ensure touch targets are at least 44px */
      button, input, select, textarea {
        min-height: 44px;
      }

      /* Optimize scrolling */
      * {
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Small screen (typical Chromebook) */
    @media (max-width: 1366px) and (max-height: 768px) {
      html { font-size: 14px; }

      .confidence-grid {
        flex-wrap: wrap;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Focus styles for accessibility */
    button:focus-visible, input:focus-visible, textarea:focus-visible {
      outline: 2px solid var(--accent-cyan);
      outline-offset: 2px;
    }

    /* Print Styles */
    @media print {
      body { 
        background: white !important; 
        color: black !important; 
        font-size: 12pt;
      }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      header, footer { display: none !important; }
      * {
        background: white !important;
        color: black !important;
        border-color: #ccc !important;
      }
    }
    .print-only { display: none; }

    /* Mobile responsiveness */
    @media (max-width: 640px) {
      html { font-size: 14px; }
      .confidence-grid { flex-direction: column; }
    }

    /* Respect reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div id="root">
    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 1rem;">
      <div style="font-size: 3rem;">üîç</div>
      <div style="font-family: monospace; color: #22d3ee; font-size: 1.25rem;">Loading Truth Hunters...</div>
    </div>
  </div>
  
  <noscript>
    <div style="padding: 2rem; text-align: center; font-family: system-ui, sans-serif; background: #0a0e1a; color: #f1f5f9; min-height: 100vh;">
      <h1>Truth Hunters: The Calibration Game</h1>
      <p style="margin: 1rem 0;">This game requires JavaScript to run.</p>
      <p>Please enable JavaScript in your browser settings and reload the page.</p>
    </div>
  </noscript>

  <script type="text/babel" data-type="module">
    // ============================================================
    // TRUTH HUNTERS: THE CALIBRATION GAME
    // A research-backed epistemic training game for middle schoolers
    // ============================================================
    // Research Base:
    // - Johnson & Johnson (2009): Cooperative learning structures
    // - Wineburg et al. (2022): Lateral reading & web credibility
    // - Barzilai & Chinn (2018): Epistemic education goals
    // - Lichtenstein et al.: Calibration training
    // ============================================================

    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    // ============================================================
    // TYPE DEFINITIONS (JSDoc for TypeScript-equivalent safety)
    // ============================================================

    /**
     * @typedef {'TRUE' | 'FALSE' | 'MIXED'} Verdict
     * @typedef {'ai-generated' | 'expert-sourced'} ClaimSource
     * @typedef {1 | 2 | 3} ConfidenceLevel
     * @typedef {'setup' | 'playing' | 'reveal' | 'discuss' | 'stake' | 'verdict' | 'result' | 'debrief'} GamePhase
     */

    /**
     * @typedef {Object} Claim
     * @property {string} id
     * @property {string} text
     * @property {Verdict} answer
     * @property {ClaimSource} source
     * @property {string} explanation
     * @property {string} errorPattern
     * @property {string} subject
     */

    /**
     * @typedef {Object} RoundResult
     * @property {number} round
     * @property {string} claimId
     * @property {Verdict | null} teamVerdict
     * @property {ConfidenceLevel} confidence
     * @property {boolean} correct
     * @property {number} points
     * @property {string} reasoning
     */

    /**
     * @typedef {Object} TeamState
     * @property {string} name
     * @property {number} score
     * @property {number} predictedScore
     * @property {RoundResult[]} results
     */

    /**
     * @typedef {Object} GameState
     * @property {GamePhase} phase
     * @property {number} currentRound
     * @property {number} totalRounds
     * @property {Claim[]} claims
     * @property {Claim | null} currentClaim
     * @property {TeamState} team
     * @property {number} timer
     * @property {boolean} timerActive
     */

    // ============================================================
    // CLAIM DATABASE
    // ============================================================

    /** @type {Claim[]} */
    const CLAIMS_DATABASE = [
      // ==================== EASY DIFFICULTY ====================
      {
        id: 'easy-001',
        text: 'The mitochondria converts glucose into ATP through a process called photosynthesis, which occurs in all animal cells.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'Mitochondria use cellular respiration, not photosynthesis. Photosynthesis occurs in chloroplasts in plant cells.',
        errorPattern: 'Confident terminology swap',
        subject: 'Biology',
        difficulty: 'easy'
      },
      {
        id: 'easy-002',
        text: 'Your brain uses about 20% of your body\'s total energy, even though it\'s only about 2% of your body weight.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Well-documented in neuroscience literature (Raichle & Gusnard, 2002). The brain\'s high metabolic demand reflects its computational complexity.',
        errorPattern: 'N/A - Accurate',
        subject: 'Neuroscience',
        difficulty: 'easy'
      },
      {
        id: 'easy-003',
        text: 'The Great Wall of China is the only human-made structure visible from space with the naked eye.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'This is a persistent myth. Astronauts confirm it\'s not visible without aid from low Earth orbit. Other structures like highways and cities are actually more visible.',
        errorPattern: 'Myth perpetuation',
        subject: 'Geography',
        difficulty: 'easy'
      },
      {
        id: 'easy-004',
        text: 'Water boils at 100 degrees Celsius (212¬∞F) at sea level.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'This is a well-established physical property of water at standard atmospheric pressure (1 atm).',
        errorPattern: 'N/A - Accurate',
        subject: 'Physics',
        difficulty: 'easy'
      },
      {
        id: 'easy-005',
        text: 'Goldfish have a 3-second memory, which is why they seem content swimming in small bowls.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'Studies show goldfish can remember things for months! They can learn mazes, recognize their owners, and remember feeding times.',
        errorPattern: 'Myth perpetuation',
        subject: 'Animal Science',
        difficulty: 'easy'
      },
      {
        id: 'easy-006',
        text: 'Bananas are berries, but strawberries are not.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Botanically, berries develop from a single ovary and have seeds embedded in flesh. Bananas qualify; strawberries are "accessory fruits."',
        errorPattern: 'N/A - Accurate',
        subject: 'Botany',
        difficulty: 'easy'
      },
      {
        id: 'easy-007',
        text: 'Humans only use 10% of their brains.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'Brain scans show we use virtually all parts of our brain, and most of the brain is active almost all the time.',
        errorPattern: 'Myth perpetuation',
        subject: 'Neuroscience',
        difficulty: 'easy'
      },
      {
        id: 'easy-008',
        text: 'A group of flamingos is called a "flamboyance."',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'This is the official collective noun for flamingos, likely inspired by their vibrant pink color and dramatic appearance.',
        errorPattern: 'N/A - Accurate',
        subject: 'Animal Science',
        difficulty: 'easy'
      },
      {
        id: 'easy-009',
        text: 'Lightning never strikes the same place twice.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'Lightning frequently strikes the same place multiple times. The Empire State Building is struck about 20-25 times per year!',
        errorPattern: 'Myth perpetuation',
        subject: 'Weather Science',
        difficulty: 'easy'
      },
      {
        id: 'easy-010',
        text: 'Octopuses have three hearts and blue blood.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Two hearts pump blood to the gills, while the third pumps it to the body. Their blood contains copper-based hemocyanin, making it blue.',
        errorPattern: 'N/A - Accurate',
        subject: 'Marine Biology',
        difficulty: 'easy'
      },
      {
        id: 'easy-011',
        text: 'The planet Venus spins in the opposite direction from most other planets in our solar system.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Venus has retrograde rotation, spinning clockwise when viewed from above its north pole, unlike Earth and most planets.',
        errorPattern: 'N/A - Accurate',
        subject: 'Astronomy',
        difficulty: 'easy'
      },
      {
        id: 'easy-012',
        text: 'Cracking your knuckles causes arthritis.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'Multiple studies have found no link between knuckle cracking and arthritis. The sound comes from gas bubbles popping in joint fluid.',
        errorPattern: 'Myth perpetuation',
        subject: 'Human Biology',
        difficulty: 'easy'
      },

      // ==================== MEDIUM DIFFICULTY ====================
      {
        id: 'med-001',
        text: 'Isaac Newton discovered gravity in 1687 when an apple fell on his head at Cambridge University, leading him to immediately publish the Principia Mathematica that same day.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Newton did publish Principia in 1687, but the apple story is likely apocryphal, and "same day" is fabricated.',
        errorPattern: 'Timeline compression',
        subject: 'History of Science',
        difficulty: 'medium'
      },
      {
        id: 'med-002',
        text: 'The Amazon River is the longest river in the world at 6,992 kilometers, flowing through Brazil, Peru, and Argentina.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'The Nile is generally considered the longest river. The Amazon doesn\'t flow through Argentina‚Äîit flows through Brazil, Peru, Colombia, and other countries.',
        errorPattern: 'Geographic fabrication',
        subject: 'Geography',
        difficulty: 'medium'
      },
      {
        id: 'med-003',
        text: 'Sound travels faster through water than through air because water molecules are packed more closely together.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Sound travels about 4.3 times faster in water (~1,480 m/s) than in air (~343 m/s) due to water\'s higher density and elasticity.',
        errorPattern: 'N/A - Accurate',
        subject: 'Physics',
        difficulty: 'medium'
      },
      {
        id: 'med-004',
        text: 'Albert Einstein failed mathematics in school, which proves that grades don\'t matter for future success.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'Einstein excelled at mathematics. This myth arose from confusion about Swiss grading scales. He mastered calculus by age 15.',
        errorPattern: 'Myth perpetuation',
        subject: 'History of Science',
        difficulty: 'medium'
      },
      {
        id: 'med-005',
        text: 'Honey never spoils. Archaeologists have found 3,000-year-old honey in Egyptian tombs that was still edible.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Honey\'s low moisture content, acidic pH, and hydrogen peroxide production make it inhospitable to bacteria and microorganisms.',
        errorPattern: 'N/A - Accurate',
        subject: 'Chemistry',
        difficulty: 'medium'
      },
      {
        id: 'med-006',
        text: 'The human body contains enough iron to make a 3-inch nail, enough carbon to make 900 pencils, and enough phosphorus to make 2,200 match heads.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'The iron claim is roughly accurate (~3-4g of iron). However, the pencil and match head numbers are exaggerated fabrications with false precision.',
        errorPattern: 'Confident specificity',
        subject: 'Chemistry',
        difficulty: 'medium'
      },
      {
        id: 'med-007',
        text: 'When you blush, the lining of your stomach also turns red.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'The same adrenaline response that dilates facial blood vessels affects the stomach lining similarly.',
        errorPattern: 'N/A - Accurate',
        subject: 'Human Biology',
        difficulty: 'medium'
      },
      {
        id: 'med-008',
        text: 'The Statue of Liberty was originally intended to be placed in Egypt at the entrance of the Suez Canal before being gifted to America.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Sculptor Bartholdi did propose a similar lighthouse statue for the Suez Canal, but it was a different design. The Statue of Liberty was always intended for America as a gift from France.',
        errorPattern: 'Plausible adjacency',
        subject: 'History',
        difficulty: 'medium'
      },
      {
        id: 'med-009',
        text: 'A day on Venus is longer than a year on Venus.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Venus rotates so slowly that one day (243 Earth days) is longer than its year (225 Earth days to orbit the Sun).',
        errorPattern: 'N/A - Accurate',
        subject: 'Astronomy',
        difficulty: 'medium'
      },
      {
        id: 'med-010',
        text: 'Vikings wore horned helmets into battle, which made them appear more fearsome to their enemies.',
        answer: 'FALSE',
        source: 'ai-generated',
        explanation: 'No archaeological evidence supports horned Viking helmets in battle. This myth comes from 19th-century romanticized artwork and opera costumes.',
        errorPattern: 'Myth perpetuation',
        subject: 'History',
        difficulty: 'medium'
      },
      {
        id: 'med-011',
        text: 'Sharks have been around longer than trees.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Sharks appeared about 450 million years ago. Trees evolved about 350 million years ago. Sharks predate trees by 100 million years!',
        errorPattern: 'N/A - Accurate',
        subject: 'Evolution',
        difficulty: 'medium'
      },
      {
        id: 'med-012',
        text: 'Mount Everest is the tallest mountain on Earth, measuring exactly 29,032 feet from base to peak.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Everest is highest above sea level, but Mauna Kea is taller base-to-peak (33,500 ft, mostly underwater). The "exact" measurement changes with snow and tectonic activity.',
        errorPattern: 'Confident specificity',
        subject: 'Geography',
        difficulty: 'medium'
      },

      // ==================== HARD DIFFICULTY ====================
      {
        id: 'hard-001',
        text: 'During the April 2024 solar eclipse, the moon\'s shadow traveled across North America at approximately 1,500 miles per hour, and the path of totality passed through Austin, Texas on April 8th.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Date and Austin are correct, but shadow speed varies significantly (~1,000-5,000 mph depending on location). The specific number presented as fact without context is misleading.',
        errorPattern: 'Confident specificity',
        subject: 'Astronomy',
        difficulty: 'hard'
      },
      {
        id: 'hard-002',
        text: 'The inventor of the Pringles can is buried in one, as specified in his will after he designed the iconic tube in 1966.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Fredric Baur\'s ashes were indeed buried in a Pringles can (true), but he was a chemist who helped develop the shape/packaging, not the sole inventor, and the year is imprecise.',
        errorPattern: 'Timeline compression',
        subject: 'History',
        difficulty: 'hard'
      },
      {
        id: 'hard-003',
        text: 'Oxford University is older than the Aztec Empire.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Teaching at Oxford began around 1096. The Aztec Empire was founded in 1428 when the Triple Alliance was formed. Oxford is over 300 years older!',
        errorPattern: 'N/A - Accurate',
        subject: 'History',
        difficulty: 'hard'
      },
      {
        id: 'hard-004',
        text: 'The shortest war in history lasted exactly 38 minutes, fought between Britain and Zanzibar on August 27, 1896, resulting in exactly 500 Zanzibari casualties.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'The Anglo-Zanzibar War did occur on that date and lasted 38-45 minutes, but casualty numbers vary (roughly 500) and "exactly" is fabricated precision.',
        errorPattern: 'Confident specificity',
        subject: 'History',
        difficulty: 'hard'
      },
      {
        id: 'hard-005',
        text: 'Cleopatra lived closer in time to the Moon landing than to the construction of the Great Pyramid of Giza.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'The Great Pyramid was built around 2560 BCE. Cleopatra lived around 30 BCE (2,530 years later). The Moon landing was 1969 CE (1,999 years after Cleopatra).',
        errorPattern: 'N/A - Accurate',
        subject: 'History',
        difficulty: 'hard'
      },
      {
        id: 'hard-006',
        text: 'CRISPR gene editing was discovered when scientists noticed bacteria defending themselves against viruses, leading to the first human trials in China in 2015 at Beijing University.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'CRISPR was discovered from bacterial immune systems (true), but the first human trials were in 2016, not 2015, and occurred at Sichuan University, not Beijing University.',
        errorPattern: 'Geographic fabrication',
        subject: 'Biotechnology',
        difficulty: 'hard'
      },
      {
        id: 'hard-007',
        text: 'There are more possible iterations of a game of chess than there are atoms in the observable universe.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'The Shannon number estimates 10^120 possible chess games. The observable universe has roughly 10^80 atoms. Chess possibilities vastly exceed atoms!',
        errorPattern: 'N/A - Accurate',
        subject: 'Mathematics',
        difficulty: 'hard'
      },
      {
        id: 'hard-008',
        text: 'The first computer programmer was a woman named Ada Lovelace, who wrote the first algorithm in 1843 for Charles Babbage\'s Difference Engine.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Ada Lovelace did write the first algorithm (true), but it was for the Analytical Engine, not the Difference Engine. These were different machines with different purposes.',
        errorPattern: 'Plausible adjacency',
        subject: 'Computer Science',
        difficulty: 'hard'
      },
      {
        id: 'hard-009',
        text: 'A single bolt of lightning contains enough energy to toast 100,000 slices of bread.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Lightning carries about 1 billion joules of energy. A toaster uses about 1,000 joules per slice. The math checks out for roughly 100,000 slices!',
        errorPattern: 'N/A - Accurate',
        subject: 'Physics',
        difficulty: 'hard'
      },
      {
        id: 'hard-010',
        text: 'The human brain generates approximately 23 watts of electrical power when awake, enough to power a standard LED light bulb, which was first measured by Dr. Hans Berger in 1929.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'The brain uses about 12-20 watts (close but "23" is false precision). Berger did pioneer EEG in 1929, but he measured brain waves, not power consumption.',
        errorPattern: 'Confident specificity',
        subject: 'Neuroscience',
        difficulty: 'hard'
      },
      {
        id: 'hard-011',
        text: 'Neutron stars are so dense that a teaspoon of neutron star material would weigh about 6 billion tons on Earth.',
        answer: 'TRUE',
        source: 'expert-sourced',
        explanation: 'Neutron stars have densities of 10^17 kg/m¬≥. A teaspoon (about 5 mL) would indeed weigh several billion tons due to this extreme density.',
        errorPattern: 'N/A - Accurate',
        subject: 'Astronomy',
        difficulty: 'hard'
      },
      {
        id: 'hard-012',
        text: 'The placebo effect can work even when patients know they\'re taking a placebo, a phenomenon discovered at Harvard Medical School in 2010 and replicated in exactly 47 subsequent studies.',
        answer: 'MIXED',
        source: 'ai-generated',
        explanation: 'Open-label placebos do work (demonstrated around 2010 at Harvard), but "exactly 47 studies" is fabricated. The real number of replications varies and isn\'t precisely 47.',
        errorPattern: 'Confident specificity',
        subject: 'Medical Science',
        difficulty: 'hard'
      }
    ];

    // ============================================================
    // AI ERROR PATTERNS (for debrief)
    // ============================================================

    const AI_ERROR_PATTERNS = [
      {
        name: 'Confident Specificity',
        description: 'Precise numbers, dates, or measurements that sound authoritative but are fabricated',
        example: '"exactly 1,500 mph" or "2,200 match heads"'
      },
      {
        name: 'Plausible Adjacency',
        description: 'Almost-right terminology swaps that sound correct to non-experts',
        example: '"photosynthesis" instead of "cellular respiration"'
      },
      {
        name: 'Myth Perpetuation',
        description: 'Repeating common misconceptions as if they were facts',
        example: 'Great Wall visible from space, Einstein failed math'
      },
      {
        name: 'Timeline Compression',
        description: 'Events mashed together implausibly or with invented connections',
        example: '"published that same day"'
      },
      {
        name: 'Geographic/Factual Invention',
        description: 'Made-up but plausible-sounding details about places, people, or events',
        example: 'Amazon flowing through Argentina'
      }
    ];

    // ============================================================
    // ACHIEVEMENTS & BADGES (Engagement System)
    // ============================================================

    const ACHIEVEMENTS = [
      {
        id: 'first-truth',
        name: 'Truth Seeker',
        description: 'Get your first answer correct',
        icon: 'üîç',
        condition: (stats) => stats.totalCorrect >= 1
      },
      {
        id: 'streak-3',
        name: 'On Fire',
        description: 'Get 3 correct answers in a row',
        icon: 'üî•',
        condition: (stats) => stats.maxStreak >= 3
      },
      {
        id: 'streak-5',
        name: 'Unstoppable',
        description: 'Get 5 correct answers in a row',
        icon: '‚ö°',
        condition: (stats) => stats.maxStreak >= 5
      },
      {
        id: 'ai-detector',
        name: 'AI Detector',
        description: 'Correctly identify 3 AI-generated claims',
        icon: 'ü§ñ',
        condition: (stats) => stats.aiCaughtCorrect >= 3
      },
      {
        id: 'calibrated',
        name: 'Well Calibrated',
        description: 'Predict your final score within ¬±2 points',
        icon: 'üéØ',
        condition: (stats) => stats.calibrationBonus
      },
      {
        id: 'humble-learner',
        name: 'Humble Learner',
        description: 'Use low confidence and get it right 3+ times',
        icon: 'üå±',
        condition: (stats) => stats.humbleCorrect >= 3
      },
      {
        id: 'risk-taker',
        name: 'Calculated Risk',
        description: 'Use high confidence and get it right 3+ times',
        icon: 'üíé',
        condition: (stats) => stats.boldCorrect >= 3
      },
      {
        id: 'perfect-round',
        name: 'Perfect Game',
        description: 'Get every answer correct in a game',
        icon: 'üëë',
        condition: (stats) => stats.perfectGame
      },
      {
        id: 'myth-buster',
        name: 'Myth Buster',
        description: 'Correctly identify 3 myth perpetuation errors',
        icon: 'üí•',
        condition: (stats) => stats.mythsBusted >= 3
      },
      {
        id: 'mixed-master',
        name: 'Nuance Navigator',
        description: 'Correctly identify 3 MIXED claims',
        icon: '‚öñÔ∏è',
        condition: (stats) => stats.mixedCorrect >= 3
      },
      {
        id: 'team-player',
        name: 'Team Spirit',
        description: 'Complete a full game with your team',
        icon: 'ü§ù',
        condition: (stats) => stats.gameCompleted
      },
      {
        id: 'comeback-kid',
        name: 'Comeback Kid',
        description: 'Win after being in negative points',
        icon: 'üöÄ',
        condition: (stats) => stats.comeback
      }
    ];

    // ============================================================
    // EDUCATIONAL TIPS (Shown between rounds)
    // ============================================================

    const EDUCATIONAL_TIPS = [
      {
        category: 'AI Detection',
        tip: 'Watch for "exactly" or very specific numbers ‚Äî AI often invents precise-sounding details.',
        icon: 'üéØ'
      },
      {
        category: 'Critical Thinking',
        tip: 'Ask yourself: "How would someone verify this?" If it seems hard to check, be skeptical.',
        icon: 'ü§î'
      },
      {
        category: 'Calibration',
        tip: 'It\'s okay to say "I\'m not sure." Knowing what you don\'t know is a superpower!',
        icon: 'üåü'
      },
      {
        category: 'Team Strategy',
        tip: 'The Skeptic role is crucial ‚Äî even if you agree, try to find a reason it might be wrong.',
        icon: 'üó£Ô∏è'
      },
      {
        category: 'AI Detection',
        tip: 'AI loves to mix true facts with false details. Look for the "too good to be true" parts.',
        icon: 'üîç'
      },
      {
        category: 'Humility',
        tip: 'Getting it wrong doesn\'t mean you\'re bad at this ‚Äî it means you\'re learning!',
        icon: 'üå±'
      },
      {
        category: 'Critical Thinking',
        tip: 'Famous stories (like Newton\'s apple) often get exaggerated over time. Question the dramatic details.',
        icon: 'üìö'
      },
      {
        category: 'Team Strategy',
        tip: 'Before locking in, ask: "Did everyone get to share their thoughts?"',
        icon: 'ü§ù'
      },
      {
        category: 'Calibration',
        tip: 'If your team disagrees, that\'s a sign to use lower confidence ‚Äî disagreement = uncertainty.',
        icon: '‚öñÔ∏è'
      },
      {
        category: 'AI Detection',
        tip: 'AI often gets the "what" right but messes up the "when" or "where" ‚Äî check those details!',
        icon: 'üìç'
      },
      {
        category: 'Humility',
        tip: 'The smartest people aren\'t always right ‚Äî they\'re the ones who update their beliefs with evidence.',
        icon: 'üß†'
      },
      {
        category: 'Critical Thinking',
        tip: 'Just because something sounds scientific doesn\'t mean it\'s true. Look for the source!',
        icon: 'üî¨'
      }
    ];

    // ============================================================
    // TEAM AVATARS & ENCOURAGEMENTS (Prosocial Elements)
    // ============================================================

    const TEAM_AVATARS = [
      { id: 'owl', emoji: 'ü¶â', name: 'Wise Owls' },
      { id: 'fox', emoji: 'ü¶ä', name: 'Clever Foxes' },
      { id: 'dolphin', emoji: 'üê¨', name: 'Smart Dolphins' },
      { id: 'eagle', emoji: 'ü¶Ö', name: 'Sharp Eagles' },
      { id: 'octopus', emoji: 'üêô', name: 'Curious Octopi' },
      { id: 'bee', emoji: 'üêù', name: 'Busy Bees' },
      { id: 'wolf', emoji: 'üê∫', name: 'Pack Wolves' },
      { id: 'rocket', emoji: 'üöÄ', name: 'Rockets' }
    ];

    const ENCOURAGEMENTS = {
      correct: [
        'Great teamwork! üéâ',
        'Your skepticism paid off!',
        'Excellent critical thinking!',
        'You saw through that one!',
        'Truth hunters strike again!',
        'Sharp eyes, sharp minds!',
        'That\'s how it\'s done!',
        'Your team is on fire! üî•'
      ],
      incorrect: [
        'Good try! That was a tricky one.',
        'Now you know for next time!',
        'Even experts get fooled sometimes.',
        'Learning moment! üìö',
        'This is how we grow!',
        'Tricky! But now you\'ll remember.',
        'The best learners make mistakes!',
        'Stay curious, keep questioning!'
      ],
      streak: [
        '2 in a row! Keep it up!',
        '3 in a row! You\'re on fire! üî•',
        '4 in a row! Incredible teamwork!',
        '5 in a row! UNSTOPPABLE! ‚ö°',
        'LEGENDARY STREAK! üëë'
      ]
    };

    // ============================================================
    // DIFFICULTY CONFIGURATION
    // ============================================================

    const DIFFICULTY_CONFIG = {
      easy: {
        name: 'Beginner',
        description: 'Common myths and straightforward facts',
        discussTime: 150, // 2:30
        stakeTime: 45,
        pointMultiplier: 1,
        color: 'var(--accent-emerald)',
        icon: 'üå±'
      },
      medium: {
        name: 'Standard',
        description: 'Mixed claims requiring careful analysis',
        discussTime: 120, // 2:00
        stakeTime: 30,
        pointMultiplier: 1.5,
        color: 'var(--accent-amber)',
        icon: '‚ö°'
      },
      hard: {
        name: 'Expert',
        description: 'Subtle errors and complex claims',
        discussTime: 90, // 1:30
        stakeTime: 25,
        pointMultiplier: 2,
        color: 'var(--accent-rose)',
        icon: 'üî•'
      },
      mixed: {
        name: 'Progressive',
        description: 'Starts easy, gets harder each round',
        discussTime: 120,
        stakeTime: 30,
        pointMultiplier: 1,
        color: 'var(--accent-violet)',
        icon: 'üìà'
      }
    };

    // Background colors for difficulty badges (rgba for proper opacity)
    const DIFFICULTY_BG_COLORS = {
      easy: 'rgba(52, 211, 153, 0.2)',
      medium: 'rgba(251, 191, 36, 0.2)',
      hard: 'rgba(251, 113, 133, 0.2)',
      mixed: 'rgba(167, 139, 250, 0.2)'
    };

    // ============================================================
    // HINT SYSTEM
    // ============================================================

    const HINT_TYPES = [
      {
        id: 'source-hint',
        name: 'Source Check',
        description: 'Reveals if claim is AI-generated or expert-sourced',
        cost: 2,
        icon: 'üîç'
      },
      {
        id: 'error-hint',
        name: 'Error Pattern',
        description: 'Hints at what type of error to look for',
        cost: 3,
        icon: 'üéØ'
      },
      {
        id: 'subject-hint',
        name: 'Subject Expert',
        description: 'Get context about this subject area',
        cost: 1,
        icon: 'üìö'
      }
    ];

    // ============================================================
    // REFLECTION PROMPTS (Humility Development)
    // ============================================================

    const REFLECTION_PROMPTS = [
      {
        question: 'What claim surprised you the most today?',
        followUp: 'What made it hard to judge?'
      },
      {
        question: 'Did your team disagree on any claims?',
        followUp: 'How did you work through the disagreement?'
      },
      {
        question: 'Which AI error pattern fooled you the most?',
        followUp: 'How will you watch for it next time?'
      },
      {
        question: 'When were you most confident but wrong?',
        followUp: 'What can you learn from that moment?'
      },
      {
        question: 'What\'s one thing you\'ll check more carefully next time?',
        followUp: 'How will you remember to do this?'
      },
      {
        question: 'How did having different team roles help your group?',
        followUp: 'Which role helped you think differently?'
      }
    ];

    // ============================================================
    // LEADERBOARD & PERSISTENCE (localStorage Backend)
    // ============================================================

    const STORAGE_KEY = 'truthHunters_leaderboard';

    /**
     * @typedef {Object} PlayerRecord
     * @property {string} firstName
     * @property {string} lastInitial
     * @property {string} odisplayName - "FirstName L."
     */

    /**
     * @typedef {Object} GameRecord
     * @property {string} id - unique game ID
     * @property {string} teamName
     * @property {string} teamAvatar - emoji
     * @property {PlayerRecord[]} players
     * @property {number} score
     * @property {number} accuracy - percentage 0-100
     * @property {string} difficulty
     * @property {number} rounds
     * @property {number} timestamp
     * @property {string[]} achievements - achievement IDs earned
     */

    const LeaderboardManager = {
      /**
       * Get all game records from localStorage
       * @returns {GameRecord[]}
       */
      getAll() {
        try {
          const data = localStorage.getItem(STORAGE_KEY);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.warn('Failed to load leaderboard:', e);
          return [];
        }
      },

      /**
       * Save a new game record
       * @param {GameRecord} record
       */
      save(record) {
        try {
          const records = this.getAll();
          records.push({
            ...record,
            id: `game_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            timestamp: Date.now()
          });
          // Keep only last 100 games to prevent storage bloat
          const trimmed = records.slice(-100);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmed));
        } catch (e) {
          console.warn('Failed to save to leaderboard:', e);
        }
      },

      /**
       * Get top teams by score
       * @param {number} limit
       * @returns {GameRecord[]}
       */
      getTopTeams(limit = 10) {
        const records = this.getAll();
        return records
          .sort((a, b) => b.score - a.score)
          .slice(0, limit);
      },

      /**
       * Get top players by aggregated score
       * @param {number} limit
       * @returns {Array<{displayName: string, totalScore: number, gamesPlayed: number, avgScore: number}>}
       */
      getTopPlayers(limit = 10) {
        const records = this.getAll();
        const playerScores = {};

        records.forEach(game => {
          if (!game.players) return;
          game.players.forEach(player => {
            const key = `${player.firstName}_${player.lastInitial}`.toLowerCase();
            const displayName = `${player.firstName} ${player.lastInitial}.`;

            if (!playerScores[key]) {
              playerScores[key] = {
                displayName,
                totalScore: 0,
                gamesPlayed: 0,
                bestScore: 0
              };
            }

            // Each player on the team shares the team's score
            playerScores[key].totalScore += game.score;
            playerScores[key].gamesPlayed += 1;
            playerScores[key].bestScore = Math.max(playerScores[key].bestScore, game.score);
          });
        });

        return Object.values(playerScores)
          .map(p => ({
            ...p,
            avgScore: Math.round(p.totalScore / p.gamesPlayed)
          }))
          .sort((a, b) => b.bestScore - a.bestScore)
          .slice(0, limit);
      },

      /**
       * Get recent games
       * @param {number} limit
       * @returns {GameRecord[]}
       */
      getRecent(limit = 10) {
        const records = this.getAll();
        return records
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, limit);
      },

      /**
       * Clear all records (for testing)
       */
      clear() {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {
          console.warn('Failed to clear leaderboard:', e);
        }
      }
    };

    /**
     * Format player display name
     * @param {string} firstName
     * @param {string} lastInitial
     * @returns {string}
     */
    const formatPlayerName = (firstName, lastInitial) => {
      const cleanFirst = (firstName || '').trim();
      const cleanLast = (lastInitial || '').trim().charAt(0).toUpperCase();
      if (!cleanFirst) return 'Anonymous';
      return cleanLast ? `${cleanFirst} ${cleanLast}.` : cleanFirst;
    };

    // ============================================================
    // SCORING UTILITIES
    // ============================================================

    /**
     * Calculate points based on correctness and confidence
     * @param {boolean} correct
     * @param {ConfidenceLevel} confidence
     * @returns {number}
     */
    const calculatePoints = (correct, confidence) => {
      const pointsMatrix = {
        1: { correct: 1, incorrect: -1 },
        2: { correct: 3, incorrect: -3 },
        3: { correct: 5, incorrect: -6 }
      };
      return pointsMatrix[confidence][correct ? 'correct' : 'incorrect'];
    };

    /**
     * Shuffle array using Fisher-Yates
     * @template T
     * @param {T[]} array
     * @returns {T[]}
     */
    const shuffleArray = (array) => {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    };

    /**
     * Select claims based on difficulty setting
     * @param {string} difficulty - 'easy' | 'medium' | 'hard' | 'mixed'
     * @param {number} count - number of claims to select
     * @returns {Claim[]}
     */
    const selectClaimsByDifficulty = (difficulty, count) => {
      if (difficulty === 'mixed') {
        // Progressive: distribute claims across difficulties
        const easyCount = Math.ceil(count * 0.3);
        const medCount = Math.ceil(count * 0.4);
        const hardCount = count - easyCount - medCount;

        const easy = shuffleArray(CLAIMS_DATABASE.filter(c => c.difficulty === 'easy')).slice(0, easyCount);
        const med = shuffleArray(CLAIMS_DATABASE.filter(c => c.difficulty === 'medium')).slice(0, medCount);
        const hard = shuffleArray(CLAIMS_DATABASE.filter(c => c.difficulty === 'hard')).slice(0, hardCount);

        // Order: easy first, then medium, then hard
        return [...easy, ...med, ...hard];
      }

      const filtered = CLAIMS_DATABASE.filter(c => c.difficulty === difficulty);
      return shuffleArray(filtered).slice(0, count);
    };

    /**
     * Calculate comprehensive game stats for achievements
     * @param {RoundResult[]} results
     * @param {Claim[]} claims
     * @param {number} score
     * @param {number} predictedScore
     * @returns {Object}
     */
    const calculateGameStats = (results, claims, score, predictedScore) => {
      const stats = {
        totalCorrect: 0,
        totalIncorrect: 0,
        maxStreak: 0,
        currentStreak: 0,
        aiCaughtCorrect: 0,
        humbleCorrect: 0,      // low confidence + correct
        boldCorrect: 0,        // high confidence + correct
        mixedCorrect: 0,       // MIXED verdicts correct
        mythsBusted: 0,        // myth perpetuation caught
        perfectGame: false,
        gameCompleted: true,
        calibrationBonus: Math.abs(score - predictedScore) <= 2,
        comeback: false,
        lowestPoint: 0
      };

      let runningScore = 0;
      let currentStreak = 0;

      results.forEach((result, index) => {
        const claim = claims.find(c => c.id === result.claimId);

        if (result.correct) {
          stats.totalCorrect++;
          currentStreak++;
          stats.maxStreak = Math.max(stats.maxStreak, currentStreak);

          // Track humble/bold correct
          if (result.confidence === 1) stats.humbleCorrect++;
          if (result.confidence === 3) stats.boldCorrect++;

          // Track MIXED correct
          if (claim?.answer === 'MIXED') stats.mixedCorrect++;

          // Track AI catches
          if (claim?.source === 'ai-generated') stats.aiCaughtCorrect++;

          // Track myths busted
          if (claim?.errorPattern === 'Myth perpetuation') stats.mythsBusted++;
        } else {
          stats.totalIncorrect++;
          currentStreak = 0;
        }

        runningScore += result.points;
        stats.lowestPoint = Math.min(stats.lowestPoint, runningScore);
      });

      stats.currentStreak = currentStreak;
      stats.perfectGame = stats.totalCorrect === results.length && results.length > 0;
      stats.comeback = stats.lowestPoint < 0 && score > 0;

      return stats;
    };

    /**
     * Get random item from array
     * @template T
     * @param {T[]} array
     * @returns {T}
     */
    const getRandomItem = (array) => array[Math.floor(Math.random() * array.length)];

    /**
     * Get rotating team role assignments based on round
     * @param {number} round
     * @returns {Array<{role: string, task: string}>}
     */
    const getRotatingRoles = (round) => {
      const roles = [
        { role: 'Reader', task: 'Read claim aloud clearly' },
        { role: 'Skeptic', task: 'Challenge assumptions' },
        { role: 'Researcher', task: 'Recall relevant knowledge' },
        { role: 'Decider', task: 'Guide final verdict' }
      ];

      // Rotate roles based on round number
      const rotation = (round - 1) % roles.length;
      return [...roles.slice(rotation), ...roles.slice(0, rotation)];
    };

    /**
     * Simple sound effect system (Chromebook-optimized)
     * Uses Web Audio API with minimal resource usage
     */
    const SoundManager = {
      ctx: null,
      enabled: true,

      init() {
        try {
          if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          }
        } catch (e) {
          console.warn('Audio not available:', e);
          this.ctx = null;
        }
      },

      play(type) {
        if (!this.enabled || !this.ctx) return;

        try {
          // Resume audio context if suspended (browser autoplay policy)
          if (this.ctx.state === 'suspended') {
            this.ctx.resume();
          }

          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.connect(gain);
          gain.connect(this.ctx.destination);

          const now = this.ctx.currentTime;

          switch(type) {
            case 'correct':
              osc.frequency.setValueAtTime(523, now); // C5
              osc.frequency.setValueAtTime(659, now + 0.1); // E5
              osc.frequency.setValueAtTime(784, now + 0.2); // G5
              gain.gain.setValueAtTime(0.3, now);
              gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
              osc.start(now);
              osc.stop(now + 0.4);
              break;

            case 'incorrect':
              osc.frequency.setValueAtTime(200, now);
              osc.frequency.setValueAtTime(150, now + 0.15);
              gain.gain.setValueAtTime(0.3, now);
              gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
              osc.start(now);
              osc.stop(now + 0.3);
              break;

            case 'tick':
              osc.frequency.setValueAtTime(800, now);
              gain.gain.setValueAtTime(0.1, now);
              gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
              osc.start(now);
              osc.stop(now + 0.05);
              break;

            case 'achievement':
              osc.frequency.setValueAtTime(523, now);
              osc.frequency.setValueAtTime(659, now + 0.1);
              osc.frequency.setValueAtTime(784, now + 0.2);
              osc.frequency.setValueAtTime(1047, now + 0.3);
              gain.gain.setValueAtTime(0.3, now);
              gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
              osc.start(now);
              osc.stop(now + 0.5);
              break;

            case 'streak':
              osc.frequency.setValueAtTime(440, now);
              osc.frequency.setValueAtTime(554, now + 0.08);
              osc.frequency.setValueAtTime(659, now + 0.16);
              gain.gain.setValueAtTime(0.25, now);
              gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
              osc.start(now);
              osc.stop(now + 0.3);
              break;
          }
        } catch (e) {
          // Silently fail if audio doesn't work
          console.warn('Sound playback failed:', e);
        }
      },

      toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
      }
    };

    /**
     * Get hint content for a claim
     * @param {Claim} claim
     * @param {string} hintType
     * @returns {string}
     */
    const getHintContent = (claim, hintType) => {
      switch(hintType) {
        case 'source-hint':
          return claim.source === 'ai-generated'
            ? 'ü§ñ This claim was generated by AI'
            : 'üìö This claim comes from expert sources';
        case 'error-hint':
          if (claim.source === 'expert-sourced') {
            return '‚úÖ This claim doesn\'t contain typical AI errors';
          }
          return `üéØ Look for: ${claim.errorPattern}`;
        case 'subject-hint':
          const subjectHints = {
            'Biology': 'Think about what you learned in life science class!',
            'Physics': 'Consider the basic laws of how things move and interact.',
            'Chemistry': 'Remember: matter, elements, and reactions.',
            'History': 'Dates and places are often where errors hide.',
            'Geography': 'Double-check locations and measurements.',
            'Astronomy': 'Space facts often sound unbelievable but might be true!',
            'Neuroscience': 'The brain is complex - be careful with percentages.',
            'History of Science': 'Famous scientist stories often get embellished.',
            'Marine Biology': 'Ocean creatures can be surprisingly strange!',
            'Human Biology': 'Your own body can be surprising.',
            'Animal Science': 'Animal facts are often exaggerated in myths.',
            'Evolution': 'Think in millions of years, not thousands.',
            'Botany': 'Plant classifications can be counterintuitive.',
            'Weather Science': 'Weather phenomena are often misunderstood.',
            'Mathematics': 'Big numbers can be hard to grasp.',
            'Computer Science': 'Tech history has many misconceptions.',
            'Biotechnology': 'Cutting-edge science dates matter.',
            'Medical Science': 'Medical claims need careful scrutiny.'
          };
          return subjectHints[claim.subject] || 'Think critically about this subject area!';
        default:
          return 'No hint available.';
      }
    };

    // ============================================================
    // ERROR BOUNDARY
    // ============================================================

    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      render() {
        if (this.state.hasError) {
          return React.createElement('div', {
            style: {
              padding: '2rem',
              textAlign: 'center',
              color: 'var(--text-primary)'
            }
          }, [
            React.createElement('h2', { key: 'title', style: { color: 'var(--accent-rose)' } }, '‚ö†Ô∏è Something went wrong'),
            React.createElement('p', { key: 'msg', style: { color: 'var(--text-secondary)', margin: '1rem 0' } }, 
              'Please refresh the page to restart the game.'),
            React.createElement('button', {
              key: 'btn',
              onClick: () => window.location.reload(),
              style: {
                padding: '0.75rem 1.5rem',
                background: 'var(--accent-cyan)',
                color: 'var(--bg-deep)',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontWeight: 600
              }
            }, 'Refresh Page')
          ]);
        }
        return this.props.children;
      }
    }

    // ============================================================
    // CUSTOM HOOKS
    // ============================================================

    /**
     * Timer hook with pause/resume and tab visibility handling
     * @param {number} initialTime
     * @param {() => void} onComplete
     */
    const useTimer = (initialTime, onComplete) => {
      const [time, setTime] = useState(initialTime);
      const [isActive, setIsActive] = useState(false);
      const [isPaused, setIsPaused] = useState(false);
      const callbackRef = useRef(onComplete);

      useEffect(() => {
        callbackRef.current = onComplete;
      }, [onComplete]);

      // Handle tab visibility - pause when hidden
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (document.hidden) {
            setIsPaused(true);
          } else {
            setIsPaused(false);
          }
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, []);

      useEffect(() => {
        if (!isActive || isPaused) return;
        
        const interval = setInterval(() => {
          setTime(t => {
            if (t <= 1) {
              setIsActive(false);
              callbackRef.current?.();
              return 0;
            }
            return t - 1;
          });
        }, 1000);

        return () => clearInterval(interval);
      }, [isActive, isPaused]);

      const start = useCallback(() => setIsActive(true), []);
      const pause = useCallback(() => setIsActive(false), []);
      const reset = useCallback((newTime) => {
        setTime(newTime ?? initialTime);
        setIsActive(false);
      }, [initialTime]);

      return { time, isActive, isPaused, start, pause, reset };
    };

    // ============================================================
    // COMPONENTS
    // ============================================================

    /** Header Component */
    const Header = ({ score, round, totalRounds, phase }) => (
      <header 
        role="banner"
        aria-label="Game status"
        style={{
        padding: '1rem 1.5rem',
        borderBottom: '1px solid var(--border)',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        background: 'rgba(17, 24, 39, 0.8)',
        backdropFilter: 'blur(8px)',
        position: 'sticky',
        top: 0,
        zIndex: 100
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
          <span style={{ fontSize: '1.5rem' }}>üîç</span>
          <h1 className="mono" style={{ 
            fontSize: '1.125rem', 
            fontWeight: 700,
            letterSpacing: '-0.025em',
            color: 'var(--accent-cyan)'
          }}>
            TRUTH HUNTERS
          </h1>
        </div>
        
        {phase !== 'setup' && phase !== 'debrief' && (
          <div style={{ display: 'flex', gap: '1.5rem', alignItems: 'center' }}>
            <div className="mono" style={{ 
              fontSize: '0.875rem',
              color: 'var(--text-secondary)'
            }}>
              ROUND <span style={{ color: 'var(--accent-amber)', fontWeight: 700 }}>{round}</span>/{totalRounds}
            </div>
            <div className="mono" style={{
              padding: '0.375rem 0.75rem',
              background: score >= 0 ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)',
              border: `1px solid ${score >= 0 ? 'var(--correct)' : 'var(--incorrect)'}`,
              borderRadius: '4px',
              fontSize: '0.875rem',
              fontWeight: 600,
              color: score >= 0 ? 'var(--correct)' : 'var(--incorrect)'
            }}>
              {score >= 0 ? '+' : ''}{score} PTS
            </div>
          </div>
        )}
      </header>
    );

    /** Timer Display Component */
    const TimerDisplay = ({ time, isActive, isPaused, label }) => {
      const isLow = time <= 10;
      
      return (
        <div 
          role="timer"
          aria-live={isLow ? 'assertive' : 'polite'}
          aria-label={`${label}: ${Math.floor(time / 60)} minutes ${time % 60} seconds remaining${isPaused ? ', paused' : ''}`}
          style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '0.25rem'
          }}
        >
          <span className="mono" style={{
            fontSize: '0.75rem',
            textTransform: 'uppercase',
            letterSpacing: '0.1em',
            color: isPaused ? 'var(--accent-amber)' : 'var(--text-muted)'
          }}>
            {isPaused ? '‚è∏ PAUSED' : label}
          </span>
          <div 
            className={`mono ${isLow && isActive ? 'animate-pulse' : ''}`}
            style={{
              fontSize: '2rem',
              fontWeight: 700,
              color: isLow ? 'var(--accent-rose)' : 'var(--accent-cyan)',
              textShadow: isLow ? '0 0 20px var(--accent-rose)' : 'none'
            }}
          >
            {Math.floor(time / 60)}:{String(time % 60).padStart(2, '0')}
          </div>
        </div>
      );
    };

    /** Claim Card Component */
    const ClaimCard = ({ claim, showAnswer = false }) => (
      <div 
        className="animate-in"
        style={{
          background: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '1.5rem',
          position: 'relative',
          overflow: 'hidden'
        }}
      >
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          height: '3px',
          background: claim.source === 'ai-generated' 
            ? 'linear-gradient(90deg, var(--accent-violet), var(--accent-rose))'
            : 'linear-gradient(90deg, var(--accent-emerald), var(--accent-cyan))'
        }} />
        
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: '1rem' 
        }}>
          <span className="mono" style={{
            fontSize: '0.75rem',
            padding: '0.25rem 0.5rem',
            background: 'var(--bg-elevated)',
            borderRadius: '4px',
            color: 'var(--text-secondary)'
          }}>
            {claim.subject}
          </span>
          
          {showAnswer && (
            <span className="mono" style={{
              fontSize: '0.75rem',
              padding: '0.25rem 0.5rem',
              background: claim.source === 'ai-generated' 
                ? 'rgba(167, 139, 250, 0.2)' 
                : 'rgba(52, 211, 153, 0.2)',
              color: claim.source === 'ai-generated' 
                ? 'var(--accent-violet)' 
                : 'var(--accent-emerald)',
              borderRadius: '4px'
            }}>
              {claim.source === 'ai-generated' ? 'ü§ñ AI-Generated' : 'üìö Expert-Sourced'}
            </span>
          )}
        </div>

        <blockquote style={{
          fontSize: '1.125rem',
          lineHeight: 1.7,
          color: 'var(--text-primary)',
          fontStyle: 'italic',
          borderLeft: '3px solid var(--accent-cyan)',
          paddingLeft: '1rem',
          margin: '1rem 0'
        }}>
          "{claim.text}"
        </blockquote>

        {showAnswer && (
          <div className="animate-in" style={{ marginTop: '1.5rem' }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.75rem',
              marginBottom: '0.75rem'
            }}>
              <span className="mono" style={{
                fontSize: '0.875rem',
                fontWeight: 700,
                padding: '0.375rem 0.75rem',
                borderRadius: '4px',
                background: claim.answer === 'TRUE' 
                  ? 'rgba(16, 185, 129, 0.2)' 
                  : claim.answer === 'FALSE'
                    ? 'rgba(239, 68, 68, 0.2)'
                    : 'rgba(251, 191, 36, 0.2)',
                color: claim.answer === 'TRUE' 
                  ? 'var(--correct)' 
                  : claim.answer === 'FALSE'
                    ? 'var(--incorrect)'
                    : 'var(--accent-amber)'
              }}>
                {claim.answer}
              </span>
              {claim.source === 'ai-generated' && (
                <span className="mono" style={{
                  fontSize: '0.75rem',
                  color: 'var(--accent-rose)'
                }}>
                  Error: {claim.errorPattern}
                </span>
              )}
            </div>
            <p style={{ 
              color: 'var(--text-secondary)',
              fontSize: '0.9375rem',
              lineHeight: 1.6
            }}>
              {claim.explanation}
            </p>
          </div>
        )}
      </div>
    );

    /** Confidence Selector Component */
    const ConfidenceSelector = ({ value, onChange, disabled }) => {
      const levels = [
        { value: 1, label: 'We think so', risk: '+1 / -1', color: 'var(--confidence-1)' },
        { value: 2, label: 'Pretty sure', risk: '+3 / -3', color: 'var(--confidence-2)' },
        { value: 3, label: 'Certain', risk: '+5 / -6', color: 'var(--confidence-3)' }
      ];

      const handleKeyDown = (e, levelValue) => {
        if (disabled) return;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          const next = Math.min(3, levelValue + 1);
          onChange(next);
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          const prev = Math.max(1, levelValue - 1);
          onChange(prev);
        }
      };

      return (
        <div role="radiogroup" aria-label="Confidence level" style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
          {levels.map((level) => (
            <button
              key={level.value}
              type="button"
              role="radio"
              aria-checked={value === level.value}
              tabIndex={value === level.value ? 0 : -1}
              onClick={() => onChange(level.value)}
              onKeyDown={(e) => handleKeyDown(e, level.value)}
              disabled={disabled}
              style={{
                flex: '1 1 auto',
                minWidth: '140px',
                padding: '1rem',
                background: value === level.value 
                  ? `${level.color}20` 
                  : 'var(--bg-elevated)',
                border: `2px solid ${value === level.value ? level.color : 'var(--border)'}`,
                borderRadius: '8px',
                cursor: disabled ? 'not-allowed' : 'pointer',
                opacity: disabled ? 0.5 : 1,
                transition: 'all 0.2s ease'
              }}
            >
              <div className="mono" style={{
                fontSize: '1.5rem',
                fontWeight: 700,
                color: level.color,
                marginBottom: '0.25rem'
              }}>
                {'‚óè'.repeat(level.value)}{'‚óã'.repeat(3 - level.value)}
              </div>
              <div style={{
                fontSize: '0.875rem',
                fontWeight: 600,
                color: 'var(--text-primary)',
                marginBottom: '0.25rem'
              }}>
                {level.label}
              </div>
              <div className="mono" style={{
                fontSize: '0.75rem',
                color: 'var(--text-muted)'
              }}>
                {level.risk}
              </div>
            </button>
          ))}
        </div>
      );
    };

    /** Verdict Selector Component */
    const VerdictSelector = ({ value, onChange, disabled }) => {
      const verdicts = [
        { value: 'TRUE', emoji: '‚úì', color: 'var(--correct)' },
        { value: 'MIXED', emoji: '‚óê', color: 'var(--accent-amber)' },
        { value: 'FALSE', emoji: '‚úó', color: 'var(--incorrect)' }
      ];

      const handleKeyDown = (e, currentIndex) => {
        if (disabled) return;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          const next = (currentIndex + 1) % verdicts.length;
          onChange(verdicts[next].value);
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          const prev = (currentIndex - 1 + verdicts.length) % verdicts.length;
          onChange(verdicts[prev].value);
        }
      };

      const currentIndex = verdicts.findIndex(v => v.value === value);

      return (
        <div role="radiogroup" aria-label="Verdict selection" style={{ display: 'flex', gap: '0.75rem' }}>
          {verdicts.map((v, i) => (
            <button
              key={v.value}
              type="button"
              role="radio"
              aria-checked={value === v.value}
              tabIndex={value === v.value || (value === null && i === 0) ? 0 : -1}
              onClick={() => onChange(v.value)}
              onKeyDown={(e) => handleKeyDown(e, i)}
              disabled={disabled}
              style={{
                flex: 1,
                padding: '1.25rem 1rem',
                background: value === v.value ? `${v.color}20` : 'var(--bg-elevated)',
                border: `2px solid ${value === v.value ? v.color : 'var(--border)'}`,
                borderRadius: '8px',
                cursor: disabled ? 'not-allowed' : 'pointer',
                opacity: disabled ? 0.5 : 1,
                transition: 'all 0.2s ease'
              }}
            >
              <div style={{
                fontSize: '1.75rem',
                marginBottom: '0.25rem',
                color: v.color
              }}>
                {v.emoji}
              </div>
              <div className="mono" style={{
                fontSize: '0.875rem',
                fontWeight: 600,
                color: value === v.value ? v.color : 'var(--text-secondary)'
              }}>
                {v.value}
              </div>
            </button>
          ))}
        </div>
      );
    };

    /** Button Component */
    const Button = ({ children, onClick, variant = 'primary', disabled, fullWidth, size = 'md', ariaLabel }) => {
      const variants = {
        primary: {
          background: 'var(--accent-cyan)',
          color: 'var(--bg-deep)',
          border: 'none'
        },
        secondary: {
          background: 'transparent',
          color: 'var(--accent-cyan)',
          border: '2px solid var(--accent-cyan)'
        },
        danger: {
          background: 'var(--accent-rose)',
          color: 'white',
          border: 'none'
        }
      };

      const sizes = {
        sm: { padding: '0.625rem 1rem', fontSize: '0.875rem', minHeight: '44px' },
        md: { padding: '0.875rem 1.5rem', fontSize: '1rem', minHeight: '44px' },
        lg: { padding: '1rem 2rem', fontSize: '1.125rem', minHeight: '48px' }
      };

      return (
        <button
          onClick={onClick}
          disabled={disabled}
          aria-label={ariaLabel}
          aria-disabled={disabled}
          className="mono"
          style={{
            ...variants[variant],
            ...sizes[size],
            width: fullWidth ? '100%' : 'auto',
            borderRadius: '8px',
            fontWeight: 600,
            cursor: disabled ? 'not-allowed' : 'pointer',
            opacity: disabled ? 0.5 : 1,
            transition: 'all 0.2s ease',
            letterSpacing: '0.025em'
          }}
        >
          {children}
        </button>
      );
    };

    /** Setup Screen - Enhanced with player inputs and leaderboard */
    const SetupScreen = ({ onStart }) => {
      const [teamName, setTeamName] = useState('');
      const [rounds, setRounds] = useState(5);
      const [difficulty, setDifficulty] = useState('mixed');
      const [selectedAvatar, setSelectedAvatar] = useState(TEAM_AVATARS[0]);
      const [soundEnabled, setSoundEnabled] = useState(true);
      const [showHowToPlay, setShowHowToPlay] = useState(false);
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [leaderboardTab, setLeaderboardTab] = useState('teams'); // 'teams' or 'players'

      // Player inputs (up to 4 players per group)
      const [players, setPlayers] = useState([
        { firstName: '', lastInitial: '' },
        { firstName: '', lastInitial: '' },
        { firstName: '', lastInitial: '' },
        { firstName: '', lastInitial: '' }
      ]);

      // Initialize sound manager
      useEffect(() => {
        SoundManager.init();
      }, []);

      const handleSoundToggle = () => {
        const newState = SoundManager.toggle();
        setSoundEnabled(newState);
        if (newState) SoundManager.play('tick');
      };

      const updatePlayer = (index, field, value) => {
        setPlayers(prev => {
          const updated = [...prev];
          updated[index] = { ...updated[index], [field]: value };
          return updated;
        });
      };

      // Get valid players (those with at least a first name)
      const validPlayers = players.filter(p => p.firstName.trim());

      // Difficulty background colors (fixed - using rgba instead of CSS var interpolation)
      const difficultyBgColors = {
        easy: 'rgba(52, 211, 153, 0.15)',
        medium: 'rgba(251, 191, 36, 0.15)',
        hard: 'rgba(251, 113, 133, 0.15)',
        mixed: 'rgba(167, 139, 250, 0.15)'
      };

      // Leaderboard data
      const topTeams = useMemo(() => LeaderboardManager.getTopTeams(10), [showLeaderboard]);
      const topPlayers = useMemo(() => LeaderboardManager.getTopPlayers(10), [showLeaderboard]);

      // Leaderboard View
      if (showLeaderboard) {
        return (
          <div style={{
            maxWidth: '640px',
            margin: '0 auto',
            padding: '1.5rem'
          }}>
            <div className="animate-in" style={{ marginBottom: '1.5rem' }}>
              <button
                onClick={() => setShowLeaderboard(false)}
                className="mono"
                style={{
                  padding: '0.5rem 1rem',
                  background: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                  borderRadius: '6px',
                  color: 'var(--text-secondary)',
                  fontSize: '0.75rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}
              >
                ‚Üê Back to Setup
              </button>
            </div>

            <div className="animate-in" style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
              <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>üèÜ</div>
              <h2 className="mono" style={{
                fontSize: '1.5rem',
                fontWeight: 700,
                color: 'var(--accent-amber)'
              }}>
                LEADERBOARD
              </h2>
            </div>

            {/* Tab Selector */}
            <div style={{
              display: 'flex',
              gap: '0.5rem',
              marginBottom: '1rem'
            }}>
              <button
                onClick={() => setLeaderboardTab('teams')}
                className="mono"
                style={{
                  flex: 1,
                  padding: '0.75rem',
                  background: leaderboardTab === 'teams' ? 'var(--accent-cyan)' : 'var(--bg-elevated)',
                  color: leaderboardTab === 'teams' ? 'var(--bg-deep)' : 'var(--text-secondary)',
                  border: `1px solid ${leaderboardTab === 'teams' ? 'var(--accent-cyan)' : 'var(--border)'}`,
                  borderRadius: '6px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  fontSize: '0.875rem'
                }}
              >
                üéØ Top Teams
              </button>
              <button
                onClick={() => setLeaderboardTab('players')}
                className="mono"
                style={{
                  flex: 1,
                  padding: '0.75rem',
                  background: leaderboardTab === 'players' ? 'var(--accent-cyan)' : 'var(--bg-elevated)',
                  color: leaderboardTab === 'players' ? 'var(--bg-deep)' : 'var(--text-secondary)',
                  border: `1px solid ${leaderboardTab === 'players' ? 'var(--accent-cyan)' : 'var(--border)'}`,
                  borderRadius: '6px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  fontSize: '0.875rem'
                }}
              >
                üë§ Top Players
              </button>
            </div>

            {/* Teams Leaderboard */}
            {leaderboardTab === 'teams' && (
              <div className="animate-in" style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                overflow: 'hidden'
              }}>
                {topTeams.length === 0 ? (
                  <div style={{
                    padding: '2rem',
                    textAlign: 'center',
                    color: 'var(--text-muted)'
                  }}>
                    No games played yet. Be the first!
                  </div>
                ) : (
                  topTeams.map((game, index) => (
                    <div
                      key={game.id}
                      style={{
                        padding: '0.875rem 1rem',
                        borderBottom: index < topTeams.length - 1 ? '1px solid var(--border)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        background: index < 3 ? 'rgba(251, 191, 36, 0.05)' : 'transparent'
                      }}
                    >
                      <div className="mono" style={{
                        width: '2rem',
                        fontSize: index < 3 ? '1.25rem' : '0.875rem',
                        color: index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : 'var(--text-muted)',
                        fontWeight: 700
                      }}>
                        {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          <span>{game.teamAvatar || 'üîç'}</span>
                          <span style={{ fontWeight: 600, color: 'var(--text-primary)' }}>
                            {game.teamName}
                          </span>
                        </div>
                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                          {game.players?.map(p => formatPlayerName(p.firstName, p.lastInitial)).join(', ') || 'Anonymous'}
                        </div>
                      </div>
                      <div className="mono" style={{
                        fontSize: '1rem',
                        fontWeight: 700,
                        color: game.score >= 0 ? 'var(--correct)' : 'var(--incorrect)'
                      }}>
                        {game.score >= 0 ? '+' : ''}{game.score}
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}

            {/* Players Leaderboard */}
            {leaderboardTab === 'players' && (
              <div className="animate-in" style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                overflow: 'hidden'
              }}>
                {topPlayers.length === 0 ? (
                  <div style={{
                    padding: '2rem',
                    textAlign: 'center',
                    color: 'var(--text-muted)'
                  }}>
                    No players yet. Start a game!
                  </div>
                ) : (
                  topPlayers.map((player, index) => (
                    <div
                      key={player.displayName}
                      style={{
                        padding: '0.875rem 1rem',
                        borderBottom: index < topPlayers.length - 1 ? '1px solid var(--border)' : 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        background: index < 3 ? 'rgba(251, 191, 36, 0.05)' : 'transparent'
                      }}
                    >
                      <div className="mono" style={{
                        width: '2rem',
                        fontSize: index < 3 ? '1.25rem' : '0.875rem',
                        color: index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : 'var(--text-muted)',
                        fontWeight: 700
                      }}>
                        {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, color: 'var(--text-primary)' }}>
                          {player.displayName}
                        </div>
                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                          {player.gamesPlayed} game{player.gamesPlayed !== 1 ? 's' : ''} ‚Ä¢ avg: {player.avgScore}
                        </div>
                      </div>
                      <div className="mono" style={{
                        fontSize: '1rem',
                        fontWeight: 700,
                        color: 'var(--accent-amber)'
                      }}>
                        Best: {player.bestScore}
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>
        );
      }

      // Main Setup View
      return (
        <div style={{
          maxWidth: '640px',
          margin: '0 auto',
          padding: '1.5rem'
        }}>
          {/* Header */}
          <div className="animate-in" style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
            <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>üîç</div>
            <h1 className="mono" style={{
              fontSize: '1.5rem',
              fontWeight: 700,
              color: 'var(--accent-cyan)',
              marginBottom: '0.25rem',
              letterSpacing: '-0.025em'
            }}>
              TRUTH HUNTERS
            </h1>
            <p style={{
              fontSize: '0.9375rem',
              color: 'var(--text-secondary)',
              fontStyle: 'italic'
            }}>
              The Calibration Game
            </p>
          </div>

          {/* Leaderboard Button */}
          <div className="animate-in" style={{
            display: 'flex',
            justifyContent: 'center',
            marginBottom: '1rem'
          }}>
            <button
              onClick={() => setShowLeaderboard(true)}
              className="mono"
              style={{
                padding: '0.5rem 1rem',
                background: 'rgba(251, 191, 36, 0.15)',
                border: '1px solid var(--accent-amber)',
                borderRadius: '6px',
                color: 'var(--accent-amber)',
                fontSize: '0.75rem',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
              }}
            >
              üèÜ View Leaderboard
            </button>
          </div>

          {/* How To Play - Collapsible */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.05s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1rem',
              marginBottom: '0.75rem'
            }}
          >
            <button
              onClick={() => setShowHowToPlay(!showHowToPlay)}
              style={{
                width: '100%',
                background: 'none',
                border: 'none',
                cursor: 'pointer',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: 0
              }}
            >
              <h2 className="mono" style={{
                fontSize: '0.8125rem',
                color: 'var(--accent-amber)',
                letterSpacing: '0.05em'
              }}>
                üìã HOW TO PLAY
              </h2>
              <span style={{ color: 'var(--text-muted)', fontSize: '0.8125rem' }}>
                {showHowToPlay ? '‚ñ≤' : '‚ñº'}
              </span>
            </button>

            {showHowToPlay && (
              <ul style={{
                listStyle: 'none',
                display: 'flex',
                flexDirection: 'column',
                gap: '0.5rem',
                marginTop: '0.75rem'
              }}>
                {[
                  'Read claims together ‚Äî some are AI-generated!',
                  'Discuss as a team using assigned roles',
                  'Vote TRUE, FALSE, or MIXED',
                  'Stake confidence points',
                  'Learn from mistakes!'
                ].map((item, i) => (
                  <li key={i} style={{
                    display: 'flex',
                    alignItems: 'flex-start',
                    gap: '0.5rem',
                    color: 'var(--text-secondary)',
                    fontSize: '0.8125rem'
                  }}>
                    <span style={{ color: 'var(--accent-cyan)' }}>‚ñ∏</span>
                    {item}
                  </li>
                ))}
              </ul>
            )}
          </div>

          {/* Team Name & Mascot */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.1s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1rem',
              marginBottom: '0.75rem'
            }}
          >
            <label className="mono" style={{
              display: 'block',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              marginBottom: '0.375rem',
              letterSpacing: '0.05em'
            }}>
              TEAM NAME *
            </label>
            <input
              type="text"
              value={teamName}
              onChange={(e) => setTeamName(e.target.value)}
              placeholder="Enter your team name..."
              maxLength={25}
              required
              autoComplete="off"
              style={{
                width: '100%',
                padding: '0.625rem 0.875rem',
                background: 'var(--bg-elevated)',
                border: '1px solid var(--border)',
                borderRadius: '6px',
                color: 'var(--text-primary)',
                fontSize: '0.9375rem',
                fontFamily: 'var(--font-serif)',
                marginBottom: '0.75rem'
              }}
            />

            <label className="mono" style={{
              display: 'block',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              marginBottom: '0.375rem',
              letterSpacing: '0.05em'
            }}>
              MASCOT
            </label>
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '0.375rem'
            }}>
              {TEAM_AVATARS.map((avatar) => (
                <button
                  key={avatar.id}
                  onClick={() => setSelectedAvatar(avatar)}
                  title={avatar.name}
                  style={{
                    padding: '0.5rem 0.375rem',
                    background: selectedAvatar.id === avatar.id
                      ? 'rgba(34, 211, 238, 0.15)'
                      : 'var(--bg-elevated)',
                    border: `2px solid ${selectedAvatar.id === avatar.id ? 'var(--accent-cyan)' : 'var(--border)'}`,
                    borderRadius: '6px',
                    cursor: 'pointer',
                    transition: 'all 0.15s ease',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '0.125rem'
                  }}
                >
                  <span style={{ fontSize: '1.25rem' }}>{avatar.emoji}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Player Inputs */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.15s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1rem',
              marginBottom: '0.75rem'
            }}
          >
            <label className="mono" style={{
              display: 'block',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              marginBottom: '0.5rem',
              letterSpacing: '0.05em'
            }}>
              üë• TEAM MEMBERS (for leaderboard)
            </label>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
              {players.map((player, index) => (
                <div key={index} style={{
                  display: 'flex',
                  gap: '0.5rem',
                  alignItems: 'center'
                }}>
                  <span className="mono" style={{
                    fontSize: '0.6875rem',
                    color: 'var(--text-muted)',
                    width: '1rem'
                  }}>
                    {index + 1}.
                  </span>
                  <input
                    type="text"
                    value={player.firstName}
                    onChange={(e) => updatePlayer(index, 'firstName', e.target.value)}
                    placeholder="First Name"
                    maxLength={15}
                    autoComplete="off"
                    style={{
                      flex: 1,
                      padding: '0.5rem 0.625rem',
                      background: 'var(--bg-elevated)',
                      border: '1px solid var(--border)',
                      borderRadius: '4px',
                      color: 'var(--text-primary)',
                      fontSize: '0.875rem',
                      fontFamily: 'var(--font-serif)'
                    }}
                  />
                  <input
                    type="text"
                    value={player.lastInitial}
                    onChange={(e) => updatePlayer(index, 'lastInitial', e.target.value.charAt(0).toUpperCase())}
                    placeholder="L"
                    maxLength={1}
                    autoComplete="off"
                    style={{
                      width: '2.5rem',
                      padding: '0.5rem',
                      background: 'var(--bg-elevated)',
                      border: '1px solid var(--border)',
                      borderRadius: '4px',
                      color: 'var(--text-primary)',
                      fontSize: '0.875rem',
                      fontFamily: 'var(--font-mono)',
                      textAlign: 'center',
                      textTransform: 'uppercase'
                    }}
                  />
                </div>
              ))}
            </div>
            <div style={{
              marginTop: '0.5rem',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              fontStyle: 'italic'
            }}>
              Enter first name + last initial (e.g., "Maya T.")
            </div>
          </div>

          {/* Difficulty */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.2s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1rem',
              marginBottom: '0.75rem'
            }}
          >
            <label className="mono" style={{
              display: 'block',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              marginBottom: '0.5rem',
              letterSpacing: '0.05em'
            }}>
              DIFFICULTY
            </label>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.375rem' }}>
              {Object.entries(DIFFICULTY_CONFIG).map(([key, config]) => (
                <button
                  key={key}
                  onClick={() => setDifficulty(key)}
                  style={{
                    padding: '0.625rem',
                    background: difficulty === key ? difficultyBgColors[key] : 'var(--bg-elevated)',
                    border: `2px solid ${difficulty === key ? config.color : 'var(--border)'}`,
                    borderRadius: '6px',
                    cursor: 'pointer',
                    transition: 'all 0.15s ease',
                    textAlign: 'left'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                    <span style={{ fontSize: '0.875rem' }}>{config.icon}</span>
                    <span className="mono" style={{
                      fontSize: '0.75rem',
                      fontWeight: 600,
                      color: difficulty === key ? config.color : 'var(--text-primary)'
                    }}>
                      {config.name}
                    </span>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Rounds */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.25s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1rem',
              marginBottom: '0.75rem'
            }}
          >
            <label className="mono" style={{
              display: 'block',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              marginBottom: '0.5rem',
              letterSpacing: '0.05em'
            }}>
              ROUNDS
            </label>
            <div style={{ display: 'flex', gap: '0.375rem' }}>
              {[3, 5, 7, 10].map((n) => (
                <button
                  key={n}
                  onClick={() => setRounds(n)}
                  className="mono"
                  style={{
                    flex: 1,
                    padding: '0.625rem 0.375rem',
                    background: rounds === n ? 'var(--accent-cyan)' : 'var(--bg-elevated)',
                    color: rounds === n ? 'var(--bg-deep)' : 'var(--text-secondary)',
                    border: `1px solid ${rounds === n ? 'var(--accent-cyan)' : 'var(--border)'}`,
                    borderRadius: '6px',
                    fontWeight: 600,
                    cursor: 'pointer',
                    fontSize: '0.8125rem'
                  }}
                >
                  {n}
                </button>
              ))}
            </div>
            <div style={{
              marginTop: '0.375rem',
              fontSize: '0.6875rem',
              color: 'var(--text-muted)',
              textAlign: 'center'
            }}>
              ~{rounds * 3} min
            </div>
          </div>

          {/* Sound + Start */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.3s',
              display: 'flex',
              gap: '0.75rem',
              marginBottom: '1rem'
            }}
          >
            <button
              onClick={handleSoundToggle}
              className="mono"
              style={{
                padding: '0.75rem',
                background: 'var(--bg-elevated)',
                border: '1px solid var(--border)',
                borderRadius: '6px',
                color: 'var(--text-secondary)',
                fontSize: '1rem',
                cursor: 'pointer'
              }}
            >
              {soundEnabled ? 'üîä' : 'üîá'}
            </button>
            <Button
              onClick={() => onStart({
                teamName: teamName || 'Team Alpha',
                rounds,
                difficulty,
                avatar: selectedAvatar,
                soundEnabled,
                players: validPlayers
              })}
              fullWidth
              size="lg"
              disabled={!teamName.trim()}
            >
              {selectedAvatar.emoji} START MISSION ‚Üí
            </Button>
          </div>

          {/* Tip */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.35s',
              padding: '0.75rem',
              background: 'var(--bg-elevated)',
              borderRadius: '6px',
              textAlign: 'center'
            }}
          >
            <div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>
              üí° {getRandomItem(EDUCATIONAL_TIPS).tip}
            </div>
          </div>
        </div>
      );
    };

    /** Playing Screen - Enhanced with hints, streaks, rotating roles */
    const PlayingScreen = ({
      claim,
      round,
      totalRounds,
      onSubmit,
      phase,
      setPhase,
      difficulty,
      currentStreak,
      hintsUsed,
      onUseHint,
      teamAvatar
    }) => {
      const [confidence, setConfidence] = useState(1);
      const [verdict, setVerdict] = useState(null);
      const [reasoning, setReasoning] = useState('');
      const [showResult, setShowResult] = useState(false);
      const [resultData, setResultData] = useState(null);
      const [timeoutWarning, setTimeoutWarning] = useState(false);
      const [activeHint, setActiveHint] = useState(null);
      const [encouragement, setEncouragement] = useState('');
      const submitRef = useRef(null);

      // Get timing based on difficulty
      const diffConfig = DIFFICULTY_CONFIG[difficulty] || DIFFICULTY_CONFIG.medium;
      const discussTime = diffConfig.discussTime;
      const stakeTime = diffConfig.stakeTime;

      const discussTimer = useTimer(discussTime, () => setPhase('stake'));
      const stakeTimer = useTimer(stakeTime, () => {
        if (submitRef.current) {
          submitRef.current();
        } else {
          setTimeoutWarning(true);
        }
      });

      // Get rotating roles for this round
      const roles = useMemo(() => getRotatingRoles(round), [round]);

      useEffect(() => {
        if (phase === 'discuss') {
          discussTimer.reset(discussTime);
          discussTimer.start();
          setTimeoutWarning(false);
          setActiveHint(null);
        } else if (phase === 'stake') {
          stakeTimer.reset(stakeTime);
          stakeTimer.start();
          setTimeoutWarning(false);
        }
      }, [phase, discussTime, stakeTime]);

      const handleSubmitVerdict = useCallback(() => {
        if (!verdict || !claim) return;

        const correct = verdict === claim.answer;
        const points = calculatePoints(correct, confidence);

        // Play sound
        SoundManager.play(correct ? 'correct' : 'incorrect');

        // Get random encouragement
        const msgs = correct ? ENCOURAGEMENTS.correct : ENCOURAGEMENTS.incorrect;
        setEncouragement(getRandomItem(msgs));

        setResultData({ correct, points, confidence, verdict });
        setShowResult(true);
        setPhase('result');
      }, [verdict, confidence, claim, setPhase]);

      useEffect(() => {
        if (verdict) {
          submitRef.current = handleSubmitVerdict;
        } else {
          submitRef.current = null;
        }
      }, [verdict, handleSubmitVerdict]);

      useEffect(() => {
        if (!showResult || !resultData || !claim) return;

        const timeoutId = setTimeout(() => {
          onSubmit({
            claimId: claim.id,
            teamVerdict: resultData.verdict,
            confidence: resultData.confidence,
            correct: resultData.correct,
            points: resultData.points,
            reasoning
          });

          setConfidence(1);
          setVerdict(null);
          setReasoning('');
          setShowResult(false);
          setResultData(null);
          setActiveHint(null);
        }, 4500);

        return () => clearTimeout(timeoutId);
      }, [showResult, resultData, claim, reasoning, onSubmit]);

      const handleHintRequest = (hintType) => {
        const hint = HINT_TYPES.find(h => h.id === hintType);
        if (!hint) return;

        const content = getHintContent(claim, hintType);
        setActiveHint({ ...hint, content });
        onUseHint(hint.cost);
        SoundManager.play('tick');
      };

      return (
        <div style={{
          maxWidth: '800px',
          margin: '0 auto',
          padding: '1.25rem'
        }}>
          {/* Top Bar: Phase + Streak */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '1rem'
          }}>
            {/* Phase Indicator */}
            <div style={{ display: 'flex', gap: '0.375rem' }}>
              {['discuss', 'stake', 'result'].map((p, i) => (
                <div
                  key={p}
                  className="mono"
                  style={{
                    padding: '0.25rem 0.5rem',
                    fontSize: '0.6875rem',
                    background: phase === p ? 'var(--accent-cyan)' : 'var(--bg-elevated)',
                    color: phase === p ? 'var(--bg-deep)' : 'var(--text-muted)',
                    borderRadius: '4px',
                    textTransform: 'uppercase'
                  }}
                >
                  {i + 1}. {p}
                </div>
              ))}
            </div>

            {/* Streak Display */}
            {currentStreak >= 2 && (
              <div className="mono animate-pulse" style={{
                padding: '0.25rem 0.625rem',
                background: 'rgba(251, 191, 36, 0.15)',
                border: '1px solid var(--accent-amber)',
                borderRadius: '4px',
                fontSize: '0.75rem',
                color: 'var(--accent-amber)',
                display: 'flex',
                alignItems: 'center',
                gap: '0.25rem'
              }}>
                üî• {currentStreak} streak
              </div>
            )}
          </div>

          {/* Timer */}
          {(phase === 'discuss' || phase === 'stake') && (
            <div style={{
              display: 'flex',
              justifyContent: 'center',
              marginBottom: '1rem'
            }}>
              <TimerDisplay
                time={phase === 'discuss' ? discussTimer.time : stakeTimer.time}
                isActive={phase === 'discuss' ? discussTimer.isActive : stakeTimer.isActive}
                isPaused={phase === 'discuss' ? discussTimer.isPaused : stakeTimer.isPaused}
                label={phase === 'discuss' ? 'Discussion Time' : 'Make Your Decision'}
              />
            </div>
          )}

          {/* Difficulty Badge */}
          {claim.difficulty && (
            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '0.75rem' }}>
              <span className="mono" style={{
                padding: '0.25rem 0.5rem',
                fontSize: '0.625rem',
                background: DIFFICULTY_BG_COLORS[claim.difficulty] || 'rgba(167, 139, 250, 0.2)',
                color: DIFFICULTY_CONFIG[claim.difficulty]?.color,
                borderRadius: '4px',
                textTransform: 'uppercase'
              }}>
                {DIFFICULTY_CONFIG[claim.difficulty]?.icon} {claim.difficulty}
              </span>
            </div>
          )}

          {/* Claim Card */}
          <ClaimCard claim={claim} showAnswer={showResult} />

          {/* Active Hint Display */}
          {activeHint && (
            <div className="animate-in" style={{
              marginTop: '1rem',
              padding: '1rem',
              background: 'rgba(167, 139, 250, 0.1)',
              border: '1px solid var(--accent-violet)',
              borderRadius: '8px'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                <span>{activeHint.icon}</span>
                <span className="mono" style={{ fontSize: '0.75rem', color: 'var(--accent-violet)' }}>
                  {activeHint.name}
                </span>
              </div>
              <div style={{ fontSize: '0.9375rem', color: 'var(--text-primary)' }}>
                {activeHint.content}
              </div>
            </div>
          )}

          {/* Discussion Phase */}
          {phase === 'discuss' && (
            <div className="animate-in" style={{ marginTop: '1.25rem' }}>
              {/* Rotating Team Roles */}
              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '1rem'
              }}>
                <h3 className="mono" style={{
                  fontSize: '0.8125rem',
                  color: 'var(--accent-amber)',
                  marginBottom: '0.75rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  üó£Ô∏è TEAM ROLES (Round {round})
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(2, 1fr)',
                  gap: '0.5rem'
                }}>
                  {roles.map((r, i) => (
                    <div key={r.role} style={{
                      padding: '0.625rem',
                      background: 'var(--bg-elevated)',
                      borderRadius: '6px',
                      borderLeft: i === 0 ? '3px solid var(--accent-cyan)' : 'none'
                    }}>
                      <div className="mono" style={{
                        fontSize: '0.6875rem',
                        color: i === 0 ? 'var(--accent-cyan)' : 'var(--accent-amber)',
                        marginBottom: '0.125rem'
                      }}>
                        {i === 0 ? 'üë§ ' : ''}{r.role}
                      </div>
                      <div style={{
                        fontSize: '0.75rem',
                        color: 'var(--text-secondary)'
                      }}>
                        {r.task}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Hint System */}
              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '1rem'
              }}>
                <h3 className="mono" style={{
                  fontSize: '0.8125rem',
                  color: 'var(--accent-violet)',
                  marginBottom: '0.75rem'
                }}>
                  üí° NEED A HINT? (costs points)
                </h3>
                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                  {HINT_TYPES.map((hint) => (
                    <button
                      key={hint.id}
                      onClick={() => handleHintRequest(hint.id)}
                      disabled={activeHint?.id === hint.id}
                      className="mono"
                      style={{
                        padding: '0.5rem 0.75rem',
                        background: activeHint?.id === hint.id
                          ? 'var(--accent-violet)'
                          : 'var(--bg-elevated)',
                        color: activeHint?.id === hint.id
                          ? 'white'
                          : 'var(--text-secondary)',
                        border: '1px solid var(--border)',
                        borderRadius: '6px',
                        fontSize: '0.75rem',
                        cursor: activeHint?.id === hint.id ? 'default' : 'pointer',
                        opacity: activeHint?.id === hint.id ? 0.7 : 1
                      }}
                    >
                      {hint.icon} {hint.name} (-{hint.cost}pts)
                    </button>
                  ))}
                </div>
              </div>

              <Button onClick={() => setPhase('stake')} fullWidth>
                Ready to Vote ‚Üí
              </Button>
            </div>
          )}

          {/* Stake Phase */}
          {phase === 'stake' && (
            <div className="animate-in" style={{ marginTop: '1.25rem' }}>
              {timeoutWarning && (
                <div style={{
                  padding: '0.625rem 1rem',
                  background: 'rgba(251, 191, 36, 0.15)',
                  border: '1px solid var(--accent-amber)',
                  borderRadius: '8px',
                  marginBottom: '0.75rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  <span>‚ö†Ô∏è</span>
                  <span style={{ color: 'var(--accent-amber)', fontSize: '0.8125rem' }}>
                    Time's up! Select a verdict to continue.
                  </span>
                </div>
              )}

              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '0.75rem'
              }}>
                <h3 className="mono" style={{
                  fontSize: '0.8125rem',
                  color: 'var(--accent-amber)',
                  marginBottom: '0.75rem'
                }}>
                  VERDICT
                </h3>
                <VerdictSelector value={verdict} onChange={setVerdict} />
              </div>

              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '0.75rem'
              }}>
                <h3 className="mono" style={{
                  fontSize: '0.8125rem',
                  color: 'var(--accent-amber)',
                  marginBottom: '0.75rem'
                }}>
                  CONFIDENCE
                </h3>
                <ConfidenceSelector value={confidence} onChange={setConfidence} />
              </div>

              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '1rem'
              }}>
                <label className="mono" style={{
                  display: 'block',
                  fontSize: '0.6875rem',
                  color: 'var(--text-muted)',
                  marginBottom: '0.375rem'
                }}>
                  WHY? (optional)
                </label>
                <textarea
                  value={reasoning}
                  onChange={(e) => setReasoning(e.target.value)}
                  placeholder="What made you choose this?"
                  rows={2}
                  style={{
                    width: '100%',
                    padding: '0.625rem',
                    background: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '6px',
                    color: 'var(--text-primary)',
                    fontSize: '0.875rem',
                    fontFamily: 'var(--font-serif)',
                    resize: 'none'
                  }}
                />
              </div>

              <Button
                onClick={handleSubmitVerdict}
                fullWidth
                disabled={!verdict}
              >
                {teamAvatar?.emoji || 'üîí'} Lock In Answer ‚Üí
              </Button>
            </div>
          )}

          {/* Result Phase */}
          {phase === 'result' && resultData && (
            <div
              className={`animate-in ${resultData.correct ? 'animate-celebrate' : 'animate-shake'}`}
              style={{
                marginTop: '1.25rem',
                background: resultData.correct
                  ? 'rgba(16, 185, 129, 0.1)'
                  : 'rgba(239, 68, 68, 0.1)',
                border: `2px solid ${resultData.correct ? 'var(--correct)' : 'var(--incorrect)'}`,
                borderRadius: '12px',
                padding: '1.5rem',
                textAlign: 'center'
              }}
            >
              <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>
                {resultData.correct ? '‚úì' : '‚úó'}
              </div>
              <div className="mono" style={{
                fontSize: '1.375rem',
                fontWeight: 700,
                color: resultData.correct ? 'var(--correct)' : 'var(--incorrect)',
                marginBottom: '0.375rem'
              }}>
                {resultData.correct ? 'CORRECT!' : 'INCORRECT'}
              </div>
              <div className="mono" style={{
                fontSize: '1.125rem',
                color: resultData.points >= 0 ? 'var(--correct)' : 'var(--incorrect)',
                marginBottom: '0.5rem'
              }}>
                {resultData.points >= 0 ? '+' : ''}{resultData.points} points
              </div>

              {/* Streak notification */}
              {resultData.correct && currentStreak >= 1 && (
                <div style={{
                  marginTop: '0.5rem',
                  padding: '0.375rem 0.75rem',
                  background: 'rgba(251, 191, 36, 0.15)',
                  borderRadius: '4px',
                  display: 'inline-block'
                }}>
                  <span className="mono" style={{ fontSize: '0.8125rem', color: 'var(--accent-amber)' }}>
                    {ENCOURAGEMENTS.streak[Math.min(currentStreak, ENCOURAGEMENTS.streak.length) - 1] || `${currentStreak + 1} in a row!`}
                  </span>
                </div>
              )}

              {/* Encouragement message */}
              <div style={{
                marginTop: '0.75rem',
                fontSize: '0.9375rem',
                color: 'var(--text-secondary)',
                fontStyle: 'italic'
              }}>
                {encouragement}
              </div>

              <div style={{
                marginTop: '0.75rem',
                fontSize: '0.8125rem',
                color: 'var(--text-muted)'
              }}>
                You said <strong>{resultData.verdict}</strong> with{' '}
                <strong>{'‚óè'.repeat(resultData.confidence)}</strong> confidence
              </div>
            </div>
          )}
        </div>
      );
    };

    /** Debrief Screen - Enhanced with achievements and reflections */
    const DebriefScreen = ({ team, claims, onRestart, difficulty, teamAvatar }) => {
      const [showPatterns, setShowPatterns] = useState(false);
      const [showAchievements, setShowAchievements] = useState(true);
      const [selectedReflection, setSelectedReflection] = useState(null);
      const [reflectionResponse, setReflectionResponse] = useState('');

      const calibrationBonus = Math.abs(team.score - team.predictedScore) <= 2 ? 3 : 0;
      const finalScore = team.score + calibrationBonus;

      // Calculate comprehensive stats
      const gameStats = useMemo(() =>
        calculateGameStats(team.results, claims, team.score, team.predictedScore),
        [team.results, claims, team.score, team.predictedScore]
      );

      // Determine earned achievements
      const earnedAchievements = useMemo(() =>
        ACHIEVEMENTS.filter(a => a.condition(gameStats)),
        [gameStats]
      );

      // Play achievement sound on mount if achievements earned
      useEffect(() => {
        if (earnedAchievements.length > 0) {
          setTimeout(() => SoundManager.play('achievement'), 500);
        }
      }, [earnedAchievements.length]);

      // Get random reflection prompt
      const reflectionPrompt = useMemo(() => getRandomItem(REFLECTION_PROMPTS), []);

      const correctCount = team.results.filter(r => r.correct).length;
      const aiClaims = claims.filter(c => c.source === 'ai-generated');
      const aiClaimResults = team.results.filter(r => {
        const claim = claims.find(c => c.id === r.claimId);
        return claim?.source === 'ai-generated';
      });
      const aiCorrectCount = aiClaimResults.filter(r => r.correct).length;
      const aiCatchRate = aiClaims.length > 0
        ? Math.round((aiCorrectCount / aiClaims.length) * 100)
        : 0;

      return (
        <div style={{
          maxWidth: '800px',
          margin: '0 auto',
          padding: '1.5rem'
        }}>
          {/* Final Score */}
          <div 
            className="animate-in"
            style={{
              background: 'linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%)',
              border: '1px solid var(--border)',
              borderRadius: '16px',
              padding: '2rem',
              textAlign: 'center',
              marginBottom: '1.5rem'
            }}
          >
            <div className="mono" style={{
              fontSize: '0.875rem',
              color: 'var(--text-muted)',
              marginBottom: '0.5rem',
              letterSpacing: '0.1em'
            }}>
              FINAL SCORE
            </div>
            <div className="mono" style={{
              fontSize: '4rem',
              fontWeight: 700,
              color: finalScore >= 0 ? 'var(--accent-cyan)' : 'var(--accent-rose)',
              lineHeight: 1,
              marginBottom: '0.5rem'
            }}>
              {finalScore}
            </div>
            <div style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
              {team.name}
            </div>
            
            {calibrationBonus > 0 && (
              <div style={{
                display: 'inline-block',
                padding: '0.5rem 1rem',
                background: 'rgba(251, 191, 36, 0.15)',
                border: '1px solid var(--accent-amber)',
                borderRadius: '8px'
              }}>
                <span className="mono" style={{ color: 'var(--accent-amber)' }}>
                  +3 CALIBRATION BONUS! üéØ
                </span>
              </div>
            )}
          </div>

          {/* Stats Grid */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.1s',
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))',
              gap: '0.75rem',
              marginBottom: '1.25rem'
            }}
          >
            {[
              { label: 'Accuracy', value: `${correctCount}/${team.results.length}`, sub: 'correct' },
              { label: 'AI Detection', value: `${aiCatchRate}%`, sub: 'caught' },
              { label: 'Best Streak', value: gameStats.maxStreak, sub: 'in a row' },
              { label: 'Predicted', value: team.predictedScore, sub: 'estimate' }
            ].map((stat, i) => (
              <div key={i} style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '10px',
                padding: '0.875rem',
                textAlign: 'center'
              }}>
                <div className="mono" style={{
                  fontSize: '0.6875rem',
                  color: 'var(--text-muted)',
                  marginBottom: '0.125rem'
                }}>
                  {stat.label}
                </div>
                <div className="mono" style={{
                  fontSize: '1.375rem',
                  fontWeight: 700,
                  color: 'var(--text-primary)'
                }}>
                  {stat.value}
                </div>
                <div style={{
                  fontSize: '0.6875rem',
                  color: 'var(--text-muted)'
                }}>
                  {stat.sub}
                </div>
              </div>
            ))}
          </div>

          {/* Achievements Section */}
          {earnedAchievements.length > 0 && (
            <div
              className="animate-in"
              style={{
                animationDelay: '0.15s',
                background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%)',
                border: '1px solid var(--accent-amber)',
                borderRadius: '12px',
                padding: '1.25rem',
                marginBottom: '1.25rem'
              }}
            >
              <button
                onClick={() => setShowAchievements(!showAchievements)}
                style={{
                  width: '100%',
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  padding: 0
                }}
              >
                <h3 className="mono" style={{
                  fontSize: '0.875rem',
                  color: 'var(--accent-amber)'
                }}>
                  üèÜ ACHIEVEMENTS UNLOCKED ({earnedAchievements.length})
                </h3>
                <span style={{ color: 'var(--text-muted)' }}>
                  {showAchievements ? '‚ñ≤' : '‚ñº'}
                </span>
              </button>

              {showAchievements && (
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))',
                  gap: '0.75rem',
                  marginTop: '1rem'
                }}>
                  {earnedAchievements.map((achievement) => (
                    <div
                      key={achievement.id}
                      className="animate-in"
                      style={{
                        padding: '0.875rem',
                        background: 'var(--bg-card)',
                        borderRadius: '8px',
                        textAlign: 'center',
                        border: '1px solid var(--border)'
                      }}
                    >
                      <div style={{ fontSize: '1.75rem', marginBottom: '0.375rem' }}>
                        {achievement.icon}
                      </div>
                      <div className="mono" style={{
                        fontSize: '0.75rem',
                        fontWeight: 600,
                        color: 'var(--accent-amber)',
                        marginBottom: '0.25rem'
                      }}>
                        {achievement.name}
                      </div>
                      <div style={{
                        fontSize: '0.6875rem',
                        color: 'var(--text-muted)'
                      }}>
                        {achievement.description}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Round Results */}
          <div 
            className="animate-in"
            style={{
              animationDelay: '0.2s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1.25rem',
              marginBottom: '1.5rem'
            }}
          >
            <h3 className="mono" style={{
              fontSize: '0.875rem',
              color: 'var(--accent-amber)',
              marginBottom: '1rem'
            }}>
              ROUND BREAKDOWN
            </h3>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
              {team.results.map((result, i) => {
                const claim = claims.find(c => c.id === result.claimId);
                return (
                  <div key={i} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.75rem',
                    padding: '0.75rem',
                    background: 'var(--bg-elevated)',
                    borderRadius: '8px'
                  }}>
                    <div style={{
                      width: '24px',
                      height: '24px',
                      borderRadius: '50%',
                      background: result.correct 
                        ? 'rgba(16, 185, 129, 0.2)' 
                        : 'rgba(239, 68, 68, 0.2)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.875rem',
                      color: result.correct ? 'var(--correct)' : 'var(--incorrect)'
                    }}>
                      {result.correct ? '‚úì' : '‚úó'}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{
                        fontSize: '0.875rem',
                        color: 'var(--text-primary)',
                        whiteSpace: 'nowrap',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis'
                      }}>
                        {claim?.text.substring(0, 50)}...
                      </div>
                      <div className="mono" style={{
                        fontSize: '0.75rem',
                        color: 'var(--text-muted)'
                      }}>
                        {result.teamVerdict} ‚Ä¢ {'‚óè'.repeat(result.confidence)}
                      </div>
                    </div>
                    <div className="mono" style={{
                      fontWeight: 600,
                      color: result.points >= 0 ? 'var(--correct)' : 'var(--incorrect)'
                    }}>
                      {result.points >= 0 ? '+' : ''}{result.points}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* AI Error Patterns */}
          <div 
            className="animate-in"
            style={{
              animationDelay: '0.3s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1.25rem',
              marginBottom: '1.5rem'
            }}
          >
            <button
              onClick={() => setShowPatterns(!showPatterns)}
              style={{
                width: '100%',
                background: 'none',
                border: 'none',
                cursor: 'pointer',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}
            >
              <h3 className="mono" style={{
                fontSize: '0.875rem',
                color: 'var(--accent-violet)'
              }}>
                ü§ñ AI ERROR PATTERNS TO REMEMBER
              </h3>
              <span style={{ color: 'var(--text-muted)' }}>
                {showPatterns ? '‚ñ≤' : '‚ñº'}
              </span>
            </button>
            
            {showPatterns && (
              <div style={{ marginTop: '1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                {AI_ERROR_PATTERNS.map((pattern, i) => (
                  <div key={i} style={{
                    padding: '0.75rem',
                    background: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    borderLeft: '3px solid var(--accent-violet)'
                  }}>
                    <div className="mono" style={{
                      fontSize: '0.875rem',
                      fontWeight: 600,
                      color: 'var(--text-primary)',
                      marginBottom: '0.25rem'
                    }}>
                      {pattern.name}
                    </div>
                    <div style={{
                      fontSize: '0.8125rem',
                      color: 'var(--text-secondary)',
                      marginBottom: '0.25rem'
                    }}>
                      {pattern.description}
                    </div>
                    <div className="mono" style={{
                      fontSize: '0.75rem',
                      color: 'var(--text-muted)',
                      fontStyle: 'italic'
                    }}>
                      e.g., {pattern.example}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Enhanced Reflection Section */}
          <div
            className="animate-in"
            style={{
              animationDelay: '0.4s',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '1.25rem',
              marginBottom: '1.25rem'
            }}
          >
            <h3 className="mono" style={{
              fontSize: '0.875rem',
              color: 'var(--accent-emerald)',
              marginBottom: '1rem'
            }}>
              ü™û TEAM REFLECTION
            </h3>

            {/* Calibration Quick Check */}
            <div style={{ marginBottom: '1.25rem' }}>
              <p style={{
                fontSize: '0.875rem',
                color: 'var(--text-secondary)',
                marginBottom: '0.75rem'
              }}>
                How was your confidence calibration?
              </p>
              <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                {[
                  { label: 'üìà Too high', value: 'overconfident' },
                  { label: '‚úÖ Just right', value: 'calibrated' },
                  { label: 'üìâ Too low', value: 'underconfident' }
                ].map((option) => (
                  <button
                    key={option.value}
                    onClick={() => setSelectedReflection(option.value)}
                    style={{
                      padding: '0.5rem 0.875rem',
                      background: selectedReflection === option.value
                        ? 'var(--accent-emerald)'
                        : 'var(--bg-elevated)',
                      color: selectedReflection === option.value
                        ? 'var(--bg-deep)'
                        : 'var(--text-secondary)',
                      border: `1px solid ${selectedReflection === option.value ? 'var(--accent-emerald)' : 'var(--border)'}`,
                      borderRadius: '6px',
                      fontSize: '0.8125rem',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                  >
                    {option.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Deep Reflection Prompt */}
            <div style={{
              padding: '1rem',
              background: 'var(--bg-elevated)',
              borderRadius: '8px',
              borderLeft: '3px solid var(--accent-emerald)'
            }}>
              <p style={{
                fontSize: '0.9375rem',
                color: 'var(--text-primary)',
                marginBottom: '0.5rem',
                fontWeight: 500
              }}>
                üí≠ {reflectionPrompt.question}
              </p>
              <p style={{
                fontSize: '0.8125rem',
                color: 'var(--text-muted)',
                fontStyle: 'italic',
                marginBottom: '0.75rem'
              }}>
                {reflectionPrompt.followUp}
              </p>
              <textarea
                value={reflectionResponse}
                onChange={(e) => setReflectionResponse(e.target.value)}
                placeholder="Share your team's thoughts..."
                rows={2}
                style={{
                  width: '100%',
                  padding: '0.625rem',
                  background: 'var(--bg-card)',
                  border: '1px solid var(--border)',
                  borderRadius: '6px',
                  color: 'var(--text-primary)',
                  fontSize: '0.875rem',
                  fontFamily: 'var(--font-serif)',
                  resize: 'none'
                }}
              />
            </div>

            {/* Humility Tip */}
            <div style={{
              marginTop: '1rem',
              padding: '0.75rem',
              background: 'rgba(52, 211, 153, 0.1)',
              borderRadius: '6px',
              fontSize: '0.8125rem',
              color: 'var(--text-secondary)'
            }}>
              <strong style={{ color: 'var(--accent-emerald)' }}>üå± Growth Mindset:</strong>{' '}
              {gameStats.totalIncorrect > gameStats.totalCorrect
                ? "Mistakes are proof you're trying! Every wrong answer teaches us something new."
                : gameStats.perfectGame
                  ? "Amazing work! Stay curious ‚Äî there's always more to learn."
                  : "Great balance of confidence and caution. Keep questioning everything!"}
            </div>
          </div>

          {/* Actions */}
          <div 
            className="animate-in no-print"
            style={{
              animationDelay: '0.5s',
              display: 'flex',
              gap: '1rem'
            }}
          >
            <Button onClick={onRestart} fullWidth>
              Play Again
            </Button>
            <Button 
              onClick={() => window.print()} 
              variant="secondary"
              fullWidth
            >
              Print Results
            </Button>
          </div>

          {/* Research Attribution */}
          <div 
            className="animate-in"
            style={{
              animationDelay: '0.6s',
              marginTop: '2rem',
              padding: '1rem',
              background: 'var(--bg-elevated)',
              borderRadius: '8px',
              fontSize: '0.75rem',
              color: 'var(--text-muted)'
            }}
          >
            <strong>Research Base:</strong> Johnson & Johnson (2009) cooperative learning ‚Ä¢ 
            Wineburg et al. (2022) lateral reading ‚Ä¢ 
            Barzilai & Chinn (2018) epistemic education ‚Ä¢ 
            Lichtenstein et al. calibration training
          </div>
        </div>
      );
    };

    /** Prediction Modal */
    const PredictionModal = ({ onSubmit, currentScore }) => {
      const [prediction, setPrediction] = useState(currentScore);

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '1rem'
        }}>
          <div 
            className="animate-in"
            style={{
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '16px',
              padding: '2rem',
              maxWidth: '400px',
              width: '100%'
            }}
          >
            <h2 className="mono" style={{
              fontSize: '1.25rem',
              color: 'var(--accent-amber)',
              marginBottom: '0.5rem'
            }}>
              üéØ FINAL PREDICTION
            </h2>
            <p style={{
              color: 'var(--text-secondary)',
              marginBottom: '1.5rem'
            }}>
              What do you think your final score will be?
              If you're within ¬±2 points, you'll earn a calibration bonus!
            </p>
            
            <div style={{ marginBottom: '1.5rem' }}>
              <div className="mono" style={{
                fontSize: '0.75rem',
                color: 'var(--text-muted)',
                marginBottom: '0.5rem'
              }}>
                Current Score: {currentScore}
              </div>
              <input
                type="number"
                value={prediction}
                onChange={(e) => setPrediction(parseInt(e.target.value) || 0)}
                style={{
                  width: '100%',
                  padding: '1rem',
                  background: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                  borderRadius: '8px',
                  color: 'var(--text-primary)',
                  fontSize: '1.5rem',
                  fontFamily: 'var(--font-mono)',
                  textAlign: 'center'
                }}
              />
            </div>

            <Button onClick={() => onSubmit(prediction)} fullWidth>
              Lock In Prediction
            </Button>
          </div>
        </div>
      );
    };

    // ============================================================
    // MAIN APP - Enhanced with all new features
    // ============================================================

    const App = () => {
      const [gameState, setGameState] = useState({
        phase: 'setup',
        currentRound: 0,
        totalRounds: 5,
        claims: [],
        currentClaim: null,
        difficulty: 'mixed',
        team: {
          name: '',
          score: 0,
          predictedScore: 0,
          results: [],
          avatar: TEAM_AVATARS[0],
          players: []
        }
      });

      const [showPrediction, setShowPrediction] = useState(false);
      const [currentStreak, setCurrentStreak] = useState(0);
      const [hintsUsed, setHintsUsed] = useState(0);
      const [showTip, setShowTip] = useState(false);
      const [currentTip, setCurrentTip] = useState(null);

      // Start game with new settings object
      const startGame = useCallback((settings) => {
        const { teamName, rounds, difficulty, avatar, soundEnabled, players } = settings;

        // Select claims based on difficulty
        const selectedClaims = selectClaimsByDifficulty(difficulty, rounds);

        // Initialize sound manager with user preference
        SoundManager.enabled = soundEnabled;

        setGameState({
          phase: 'playing',
          currentRound: 1,
          totalRounds: rounds,
          claims: selectedClaims,
          currentClaim: selectedClaims[0],
          difficulty: difficulty,
          team: {
            name: teamName,
            score: 0,
            predictedScore: 0,
            results: [],
            avatar: avatar,
            players: players || []
          }
        });

        setCurrentStreak(0);
        setHintsUsed(0);
      }, []);

      const [playPhase, setPlayPhase] = useState('discuss');

      // Handle hint usage (deduct points)
      const handleUseHint = useCallback((cost) => {
        setHintsUsed(prev => prev + 1);
        setGameState(prev => ({
          ...prev,
          team: {
            ...prev.team,
            score: prev.team.score - cost
          }
        }));
      }, []);

      const handleRoundSubmit = useCallback((result) => {
        // Update streak
        if (result.correct) {
          setCurrentStreak(prev => prev + 1);
          // Play streak sound if streak >= 2
          if (currentStreak >= 1) {
            setTimeout(() => SoundManager.play('streak'), 300);
          }
        } else {
          setCurrentStreak(0);
        }

        setGameState(prev => {
          const newResults = [...prev.team.results, { ...result, round: prev.currentRound }];
          const newScore = prev.team.score + result.points;

          const isLastRound = prev.currentRound >= prev.totalRounds;

          if (isLastRound) {
            setShowPrediction(true);
          } else {
            // Show educational tip between rounds (50% chance)
            if (Math.random() > 0.5) {
              setCurrentTip(getRandomItem(EDUCATIONAL_TIPS));
              setShowTip(true);
            }
          }

          return {
            ...prev,
            currentRound: isLastRound ? prev.currentRound : prev.currentRound + 1,
            currentClaim: isLastRound ? null : prev.claims[prev.currentRound],
            team: {
              ...prev.team,
              score: newScore,
              results: newResults
            }
          };
        });
        setPlayPhase('discuss');
      }, [currentStreak]);

      const handlePrediction = useCallback((prediction) => {
        setShowPrediction(false);
        setGameState(prev => {
          // Calculate final score with calibration bonus
          const calibrationBonus = Math.abs(prev.team.score - prediction) <= 2 ? 3 : 0;
          const finalScore = prev.team.score + calibrationBonus;

          // Save to leaderboard
          LeaderboardManager.save({
            teamName: prev.team.name,
            teamAvatar: prev.team.avatar?.emoji || 'üîç',
            players: prev.team.players || [],
            score: finalScore,
            difficulty: prev.difficulty,
            rounds: prev.totalRounds,
            correctCount: prev.team.results.filter(r => r.correct).length,
            calibrationBonus: calibrationBonus,
            predictedScore: prediction,
            actualScore: prev.team.score
          });

          return {
            ...prev,
            phase: 'debrief',
            team: {
              ...prev.team,
              predictedScore: prediction
            }
          };
        });
      }, []);

      const handleDismissTip = useCallback(() => {
        setShowTip(false);
        setCurrentTip(null);
      }, []);

      const restartGame = useCallback(() => {
        setGameState({
          phase: 'setup',
          currentRound: 0,
          totalRounds: 5,
          claims: [],
          currentClaim: null,
          difficulty: 'mixed',
          team: {
            name: '',
            score: 0,
            predictedScore: 0,
            results: [],
            avatar: TEAM_AVATARS[0],
            players: []
          }
        });
        setPlayPhase('discuss');
        setCurrentStreak(0);
        setHintsUsed(0);
        setShowTip(false);
      }, []);

      return (
        <>
          <Header
            score={gameState.team.score}
            round={gameState.currentRound}
            totalRounds={gameState.totalRounds}
            phase={gameState.phase}
          />

          <main role="main" style={{ flex: 1 }}>
            {gameState.phase === 'setup' && (
              <SetupScreen onStart={startGame} />
            )}

            {gameState.phase === 'playing' && gameState.currentClaim && (
              <PlayingScreen
                claim={gameState.currentClaim}
                round={gameState.currentRound}
                totalRounds={gameState.totalRounds}
                onSubmit={handleRoundSubmit}
                phase={playPhase}
                setPhase={setPlayPhase}
                difficulty={gameState.difficulty}
                currentStreak={currentStreak}
                hintsUsed={hintsUsed}
                onUseHint={handleUseHint}
                teamAvatar={gameState.team.avatar}
              />
            )}

            {gameState.phase === 'debrief' && (
              <DebriefScreen
                team={gameState.team}
                claims={gameState.claims}
                onRestart={restartGame}
                difficulty={gameState.difficulty}
                teamAvatar={gameState.team.avatar}
              />
            )}
          </main>

          {/* Prediction Modal */}
          {showPrediction && (
            <PredictionModal
              onSubmit={handlePrediction}
              currentScore={gameState.team.score}
            />
          )}

          {/* Educational Tip Modal (between rounds) */}
          {showTip && currentTip && (
            <div style={{
              position: 'fixed',
              inset: 0,
              background: 'rgba(0, 0, 0, 0.75)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
              padding: '1rem'
            }}>
              <div
                className="animate-in"
                style={{
                  background: 'var(--bg-card)',
                  border: '1px solid var(--border)',
                  borderRadius: '16px',
                  padding: '1.75rem',
                  maxWidth: '400px',
                  width: '100%',
                  textAlign: 'center'
                }}
              >
                <div style={{ fontSize: '2.5rem', marginBottom: '0.75rem' }}>
                  {currentTip.icon}
                </div>
                <div className="mono" style={{
                  fontSize: '0.75rem',
                  color: 'var(--accent-violet)',
                  marginBottom: '0.5rem',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em'
                }}>
                  üí° {currentTip.category}
                </div>
                <p style={{
                  fontSize: '1rem',
                  color: 'var(--text-primary)',
                  lineHeight: 1.6,
                  marginBottom: '1.25rem'
                }}>
                  {currentTip.tip}
                </p>
                <Button onClick={handleDismissTip} fullWidth>
                  Got it! Next Round ‚Üí
                </Button>
              </div>
            </div>
          )}

          <footer className="no-print" style={{
            padding: '0.875rem',
            borderTop: '1px solid var(--border)',
            textAlign: 'center'
          }}>
            <p className="mono" style={{
              fontSize: '0.6875rem',
              color: 'var(--text-muted)'
            }}>
              Truth Hunters ‚Ä¢ Research-based epistemic training for middle schoolers ‚Ä¢ {gameState.team.avatar?.emoji || 'üîç'}
            </p>
          </footer>
        </>
      );
    };

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      React.createElement(ErrorBoundary, null,
        React.createElement(App)
      )
    );
  </script>
</body>
</html>
