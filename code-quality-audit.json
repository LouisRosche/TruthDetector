{
  "audit_metadata": {
    "project": "Truth-Hunters Web Application",
    "audit_date": "2025-12-25",
    "auditor": "Code Quality Analysis",
    "scope": "src/ directory - Components, Services, Hooks, Utils",
    "total_findings": 87
  },
  "summary": {
    "critical": 8,
    "high": 19,
    "medium": 38,
    "low": 22,
    "categories": {
      "code_smells": 28,
      "error_handling": 15,
      "state_management": 11,
      "type_safety": 12,
      "testing": 8,
      "documentation": 9,
      "best_practices": 4
    }
  },
  "findings": [
    {
      "finding_id": "CODE-001",
      "severity": "critical",
      "category": "code_smells",
      "location": "src/App.jsx:456-651",
      "description": "Extremely long function handleRoundSubmit (195 lines) with excessive complexity and multiple responsibilities",
      "code_snippet": "const handleRoundSubmit = useCallback(\n    (result) => {\n      // 195 lines of complex logic\n      // Handles analytics, streaks, state updates, achievements, Firebase, etc.\n    },\n    [currentStreak, gameState.currentClaim?.subject]\n  );",
      "remediation": "Extract separate functions: updateStreak, calculateFinalScore, saveGameResults, awardAchievements. Consider using a reducer pattern or game state manager.",
      "impact": "Difficult to test, maintain, and debug. High cyclomatic complexity increases bug probability."
    },
    {
      "finding_id": "CODE-002",
      "severity": "high",
      "category": "code_smells",
      "location": "src/App.jsx:97-165",
      "description": "Complex useEffect with deep nesting (4 levels) and multiple responsibilities",
      "code_snippet": "useEffect(() => {\n  if (!sessionId || !FirebaseBackend.initialized || !FirebaseBackend.getClassCode()) {\n    return;\n  }\n  if (gameState.phase === 'playing') {\n    if (sessionUpdateTimeoutRef.current) {\n      clearTimeout(sessionUpdateTimeoutRef.current);\n    }\n    sessionUpdateTimeoutRef.current = setTimeout(() => {\n      // nested logic\n    }, 2000);\n  }\n  if (gameState.phase === 'debrief' && sessionId) {\n    // more nested logic\n  }\n}, [/* complex dependencies */]);",
      "remediation": "Split into separate effects: useFirebaseSession, useGamePhaseTracking. Extract session update logic to custom hook.",
      "impact": "Hard to understand control flow, difficult to test, potential memory leaks."
    },
    {
      "finding_id": "CODE-003",
      "severity": "high",
      "category": "code_smells",
      "location": "src/components/PlayingScreen.jsx:1-841",
      "description": "Component too large (841 lines) with excessive state variables (15+) and complex logic",
      "code_snippet": "export function PlayingScreen({...}) {\n  const [confidence, setConfidence] = useState(2);\n  const [verdict, setVerdict] = useState(null);\n  const [reasoning, setReasoning] = useState('');\n  const [showResult, setShowResult] = useState(false);\n  const [resultData, setResultData] = useState(null);\n  const [activeHint, setActiveHint] = useState(null);\n  // 10+ more state variables\n  // 800+ lines of logic\n}",
      "remediation": "Extract components: VerdictSubmission, ResultDisplay, HintSystem. Create usePlayingScreenState custom hook to consolidate state logic.",
      "impact": "Difficult to maintain, test, and reason about. Performance issues from excessive re-renders."
    },
    {
      "finding_id": "CODE-004",
      "severity": "critical",
      "category": "error_handling",
      "location": "src/services/firebase.js:196-229",
      "description": "Missing error boundary for save operation - silent failure could lose user data",
      "code_snippet": "async save(record) {\n  if (!this.initialized || !this.db) {\n    return false; // Silent failure\n  }\n  try {\n    await addDoc(gamesRef, docData);\n    return true;\n  } catch (e) {\n    logger.warn('Failed to save to Firebase:', e); // Only logs\n    return false; // No user notification\n  }\n}",
      "remediation": "Throw error or use offline queue fallback. Notify user of save failures. Implement retry logic.",
      "impact": "User data loss without notification. Breaks user trust and data integrity."
    },
    {
      "finding_id": "CODE-005",
      "severity": "high",
      "category": "error_handling",
      "location": "src/components/TeacherDashboard.jsx:120-171",
      "description": "Unhandled promise rejection in loadData with inadequate fallback",
      "code_snippet": "const loadData = useCallback(async () => {\n  try {\n    const [firebaseReflections, firebaseGames, ...] = await Promise.all([...]);\n    // Handle success\n  } catch (err) {\n    setError('Failed to load data. Please try again.'); // Generic error\n    const localGames = LeaderboardManager.getAll(); // Fallback\n    setGames(localGames);\n  }\n}, [isOnline]);",
      "remediation": "Implement specific error messages based on error type. Add retry mechanism. Log errors to error tracking service.",
      "impact": "Poor user experience with vague error messages. No error tracking for debugging."
    },
    {
      "finding_id": "CODE-006",
      "severity": "critical",
      "category": "state_management",
      "location": "src/App.jsx:42-57",
      "description": "Complex nested state object with deeply nested properties prone to mutation bugs",
      "code_snippet": "const [gameState, setGameState] = useState({\n  phase: 'setup',\n  currentRound: 0,\n  totalRounds: 5,\n  claims: [],\n  currentClaim: null,\n  difficulty: 'mixed',\n  team: {\n    name: '',\n    score: 0,\n    predictedScore: 0,\n    results: [],\n    avatar: TEAM_AVATARS[0],\n    players: []\n  }\n});",
      "remediation": "Use useReducer for complex state. Consider state management library (Zustand/Jotai). Flatten state structure.",
      "impact": "Easy to create bugs with incomplete state updates. Difficult to track state changes."
    },
    {
      "finding_id": "CODE-007",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/PlayingScreen.jsx:212-269",
      "description": "Duplicate logic between handleSubmitVerdict and pendingSubmit effect handler",
      "code_snippet": "// Same calculation logic repeated twice\nconst pointsResult = calculatePoints(correct, confidence, difficulty, {...});\nconst points = typeof pointsResult === 'number' ? pointsResult : pointsResult.points;\nconst speedBonus = typeof pointsResult === 'object' ? pointsResult.speedBonus : null;",
      "remediation": "Extract shared logic to helper function processVerdictSubmission(verdict, claim, confidence, ...)",
      "impact": "Code duplication increases maintenance burden and bug risk."
    },
    {
      "finding_id": "CODE-008",
      "severity": "high",
      "category": "code_smells",
      "location": "src/services/firebase.js:289-345",
      "description": "N+1 query pattern - fetches all games then processes client-side",
      "code_snippet": "async getTopPlayers(limitCount = 10, classFilter = null) {\n  // Fetches 500 games\n  const snapshot = await getDocs(q);\n  const games = snapshot.docs.map(...);\n  // Client-side aggregation\n  const aggregated = aggregatePlayerScores(games);\n  return aggregated.slice(0, limitCount);\n}",
      "remediation": "Implement server-side aggregation using Cloud Functions. Create playerStats collection updated via triggers.",
      "impact": "Poor performance, high bandwidth usage, expensive Firebase reads."
    },
    {
      "finding_id": "CODE-009",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/components/PlayingScreen.jsx:174-209",
      "description": "Timer cleanup missing error handling and edge case validation",
      "code_snippet": "useEffect(() => {\n  if (!showResult && claim) {\n    roundStartTimeRef.current = Date.now();\n    timerIntervalRef.current = setInterval(() => {\n      if (roundStartTimeRef.current) {\n        const elapsed = Math.floor((Date.now() - roundStartTimeRef.current) / 1000);\n        // No validation of elapsed value\n      }\n    }, 1000);\n  }\n}, [showResult, claim, totalTimeAllowed]);",
      "remediation": "Add bounds checking for elapsed time. Validate timerIntervalRef before clearing. Handle clock skew.",
      "impact": "Potential infinite timers, negative time values, memory leaks."
    },
    {
      "finding_id": "CODE-010",
      "severity": "high",
      "category": "type_safety",
      "location": "src/utils/scoring.js:47-103",
      "description": "Weak input validation - only checks confidence but not other parameters",
      "code_snippet": "export function calculatePoints(correct, confidence, difficulty = 'easy', options = null) {\n  if (!confidence || typeof confidence !== 'number' || confidence < 1 || confidence > 3) {\n    throw new Error(`Invalid confidence`);\n  }\n  // Missing validation for 'correct', 'difficulty', 'options'\n  const basePoints = POINTS_MATRIX[confidence][correct ? 'correct' : 'incorrect'];\n}",
      "remediation": "Add validation for all parameters. Use TypeScript or JSDoc with type checking. Validate difficulty against allowed values.",
      "impact": "Runtime errors from invalid inputs. Hard to debug type-related issues."
    },
    {
      "finding_id": "CODE-011",
      "severity": "critical",
      "category": "security",
      "location": "src/services/firebase.js:34-42",
      "description": "Firebase API keys exposed in client-side code via environment variables",
      "code_snippet": "const FIREBASE_CONFIG = {\n  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,\n  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,\n  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,\n  // ...\n};",
      "remediation": "Implement Firebase Security Rules to restrict access. Add API key restrictions in Firebase Console (HTTP referrers). Document that API keys in client code are normal for Firebase but require proper security rules.",
      "impact": "Potential unauthorized access if security rules not properly configured. Best practice: ensure Firestore rules prevent abuse."
    },
    {
      "finding_id": "CODE-012",
      "severity": "medium",
      "category": "state_management",
      "location": "src/components/SetupScreen.jsx:48-66",
      "description": "Excessive useState calls (10+) that could be consolidated",
      "code_snippet": "const [teamName, setTeamName] = useState(...);\nconst [rounds, setRounds] = useState(...);\nconst [difficulty, setDifficulty] = useState(...);\nconst [selectedAvatar, setSelectedAvatar] = useState(...);\nconst [soundEnabled, setSoundEnabled] = useState(...);\nconst [showHowToPlay, setShowHowToPlay] = useState(false);\nconst [showLeaderboard, setShowLeaderboard] = useState(false);\nconst [showSoloStats, setShowSoloStats] = useState(false);\nconst [showClaimSubmission, setShowClaimSubmission] = useState(false);\nconst [showMySubmissions, setShowMySubmissions] = useState(false);\nconst [validationError, setValidationError] = useState('');\nconst [selectedSubjects, setSelectedSubjects] = useState([]);",
      "remediation": "Use useReducer for form state. Group related modal states into single state object. Extract to custom hook useSetupForm().",
      "impact": "Performance overhead from multiple state updates. Harder to manage state changes."
    },
    {
      "finding_id": "CODE-013",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/App.jsx:168-209",
      "description": "Complex cleanup logic with nested retry loops (3+ levels)",
      "code_snippet": "const cleanup = async () => {\n  if (sessionId && FirebaseBackend.initialized) {\n    let retries = 3;\n    while (retries > 0) {\n      try {\n        await FirebaseBackend.removeActiveSession(sessionId);\n        break;\n      } catch (err) {\n        retries--;\n        if (retries === 0) {\n          if (window.navigator.sendBeacon) {\n            // More nesting\n          }\n        } else {\n          await new Promise(resolve => setTimeout(resolve, 200));\n        }\n      }\n    }\n  }\n};",
      "remediation": "Extract to utility function retryWithBackoff(). Use exponential backoff library. Simplify nesting.",
      "impact": "Hard to test and maintain. Potential infinite loops if conditions not met."
    },
    {
      "finding_id": "CODE-014",
      "severity": "high",
      "category": "best_practices",
      "location": "src/components/PlayingScreen.jsx:166",
      "description": "useEffect dependency array issues - uses memoized handler but complex dependencies",
      "code_snippet": "}, [showResult, verdict]); // Include all dependencies used inside handler",
      "remediation": "Review all dependencies. Consider using useCallback with stable dependencies. Add ESLint exhaustive-deps rule.",
      "impact": "Potential stale closures, missed updates, or excessive re-renders."
    },
    {
      "finding_id": "CODE-015",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/utils/game.js:26-139",
      "description": "Async function selectClaimsByDifficulty has no try-catch, errors bubble up uncaught",
      "code_snippet": "export async function selectClaimsByDifficulty(difficulty, count, subjects = [], ...) {\n  let basePool;\n  if (classSettings?.gradeLevel) {\n    basePool = await loadFilteredClaims({...}); // Could throw\n  } else {\n    const CLAIMS_DATABASE = await loadClaimsDatabase(); // Could throw\n    basePool = [...CLAIMS_DATABASE];\n  }\n  // No error handling\n}",
      "remediation": "Add try-catch wrapper. Return empty array on error with console.error. Add error parameter to return value.",
      "impact": "Unhandled promise rejection crashes. Poor user experience with no fallback."
    },
    {
      "finding_id": "CODE-016",
      "severity": "low",
      "category": "documentation",
      "location": "src/App.jsx:1-1139",
      "description": "Missing JSDoc comments for complex functions like handleRoundSubmit",
      "code_snippet": "const handleRoundSubmit = useCallback(\n    (result) => {\n      // Complex logic with no documentation\n    },\n    [currentStreak, gameState.currentClaim?.subject]\n  );",
      "remediation": "Add JSDoc: @param {Object} result - Round submission result, @returns {void}, @description Updates game state after round completion",
      "impact": "Difficult for new developers to understand function behavior and parameters."
    },
    {
      "finding_id": "CODE-017",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/TeacherDashboard.jsx:1-1870",
      "description": "Extremely large component (1870 lines) - violates Single Responsibility Principle",
      "code_snippet": "export function TeacherDashboard({ onBack }) {\n  // Handles: stats, reflections, games, claims, achievements, settings, export\n  // 1870 lines\n}",
      "remediation": "Split into subcomponents: StatsTab, ReflectionsTab, GamesTab, ClaimsTab, AchievementsTab, SettingsTab, ExportTab. Use tabs router.",
      "impact": "Extremely difficult to maintain. Poor code organization. Performance issues."
    },
    {
      "finding_id": "CODE-018",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/DebriefScreen.jsx:99-165",
      "description": "Complex async logic in callback without error handling",
      "code_snippet": "const handleShare = useCallback(async () => {\n  try {\n    if (navigator.share) {\n      await navigator.share({...});\n    } else {\n      await navigator.clipboard.writeText(shareText);\n    }\n  } catch (err) {\n    if (err.name !== 'AbortError') {\n      try {\n        await navigator.clipboard.writeText(shareText);\n      } catch {\n        setShareStatus('error');\n      }\n    }\n  }\n}, [...]);",
      "remediation": "Extract share logic to service/utils. Simplify nested try-catch. Add specific error handling for different failure modes.",
      "impact": "Hard to test. Complex error handling logic buried in component."
    },
    {
      "finding_id": "CODE-019",
      "severity": "high",
      "category": "memory_leaks",
      "location": "src/App.jsx:274-281",
      "description": "Missing cleanup for streakSoundTimeoutRef in some code paths",
      "code_snippet": "useEffect(() => {\n  return () => {\n    if (streakSoundTimeoutRef.current) {\n      clearTimeout(streakSoundTimeoutRef.current);\n    }\n  };\n}, []); // Empty deps - only cleans up on unmount",
      "remediation": "Also clear timeout in handleRoundSubmit when resetting state. Add cleanup to all refs on phase changes.",
      "impact": "Memory leaks from dangling timeouts. Unexpected sound playback after component unmount."
    },
    {
      "finding_id": "CODE-020",
      "severity": "medium",
      "category": "type_safety",
      "location": "src/services/firebase.js:374-472",
      "description": "Missing PropTypes/TypeScript for complex function parameters",
      "code_snippet": "async submitClaim(claimData) {\n  // claimData structure not validated beyond basic checks\n  if (!claimData.claimText || claimData.claimText.trim().length < 10) {\n    return { success: false, error: '...' };\n  }\n}",
      "remediation": "Add comprehensive input validation schema (Zod/Yup). Document expected claimData structure in JSDoc.",
      "impact": "Runtime errors from unexpected data shapes. Difficult to use API correctly."
    },
    {
      "finding_id": "CODE-021",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/SetupScreen.jsx:183-190",
      "description": "useCallback with no dependencies - could be moved outside component",
      "code_snippet": "const toggleSubject = useCallback((subject) => {\n  setSelectedSubjects(prev => {\n    if (prev.includes(subject)) {\n      return prev.filter(s => s !== subject);\n    }\n    return [...prev, subject];\n  });\n}, []); // No dependencies",
      "remediation": "Move to utils or use inline function. UseCallback with empty deps provides minimal benefit.",
      "impact": "Negligible performance impact but adds unnecessary complexity."
    },
    {
      "finding_id": "CODE-022",
      "severity": "critical",
      "category": "error_handling",
      "location": "src/components/PlayingScreen.jsx:213-238",
      "description": "Race condition between timer expiry and manual submission - no proper locking",
      "code_snippet": "useEffect(() => {\n  if (pendingSubmit && claim && !isSubmitting) {\n    setPendingSubmit(false);\n    setIsSubmitting(true);\n    // Process submission\n  }\n}, [pendingSubmit, ...]);",
      "remediation": "Use atomic flag or ref for submission state. Implement proper lock mechanism. Add unit tests for race conditions.",
      "impact": "Possible double submission, inconsistent state, duplicate Firebase writes."
    },
    {
      "finding_id": "CODE-023",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/services/firebase.js:419-434",
      "description": "Complex duplicate detection logic embedded in submitClaim - belongs in utils",
      "code_snippet": "const isDuplicate = existingClaims.some(existing => {\n  const normalizedExisting = (existing.claimText || '').toLowerCase().replace(/\\s+/g, ' ').trim();\n  if (normalizedExisting === normalizedNewText) return true;\n  const shorter = Math.min(...);\n  // Complex similarity checking\n});",
      "remediation": "Extract to utils/similarity.js: checkTextSimilarity(text1, text2, threshold). Add unit tests.",
      "impact": "Hard to test and reuse. Business logic mixed with service layer."
    },
    {
      "finding_id": "CODE-024",
      "severity": "high",
      "category": "performance",
      "location": "src/services/firebase.js:1186-1205",
      "description": "Transaction used unnecessarily for simple merge operation",
      "code_snippet": "await runTransaction(this.db, async (transaction) => {\n  const snapshot = await transaction.get(seenDoc);\n  let existingIds = [];\n  if (snapshot.exists()) {\n    existingIds = snapshot.data().claimIds || [];\n  }\n  const allIds = [...new Set([...existingIds, ...claimIds])];\n  transaction.set(seenDoc, {...});\n});",
      "remediation": "Use arrayUnion for atomic array operations. Transaction overkill for this use case unless race conditions expected.",
      "impact": "Higher latency and cost. Unnecessary complexity for simple array merge."
    },
    {
      "finding_id": "CODE-025",
      "severity": "medium",
      "category": "testing",
      "location": "src/App.jsx:327-390",
      "description": "Complex async function startGame with no visible unit tests",
      "code_snippet": "const startGame = useCallback(async (settings) => {\n  setIsPreparingGame(true);\n  try {\n    const playerProfile = PlayerProfile.get();\n    const previouslySeenIds = playerProfile.claimsSeen || [];\n    // Multiple async operations\n    const selectedClaims = selectClaimsByDifficulty(...);\n    // Complex state updates\n  } finally {\n    setIsPreparingGame(false);\n  }\n}, []);",
      "remediation": "Extract logic to testable service function. Add integration tests for happy path and error cases. Mock Firebase calls.",
      "impact": "Untested code likely to break. Difficult to verify correctness."
    },
    {
      "finding_id": "CODE-026",
      "severity": "low",
      "category": "documentation",
      "location": "src/utils/scoring.js:1-169",
      "description": "Good JSDoc present but missing @example tags for complex functions",
      "code_snippet": "/**\n * Calculate points based on correctness and confidence\n * @param {boolean} correct - Whether the answer was correct\n * @param {1|2|3} confidence - Confidence level (1-3)\n * @returns {number|Object} Points\n */",
      "remediation": "Add @example tags showing typical usage and edge cases. Particularly for calculateSpeedBonus and calculateGameStats.",
      "impact": "Minor - developers need to read implementation to understand usage patterns."
    },
    {
      "finding_id": "CODE-027",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/DebriefScreen.jsx:252-273",
      "description": "useMemo calculating complex stats - could be service layer",
      "code_snippet": "const stats = useMemo(\n  () => calculateGameStats(team.results, claims, team.score, team.predictedScore),\n  [team.results, claims, team.score, team.predictedScore]\n);",
      "remediation": "Move calculation outside component or to service. UseMemo appropriate but consider if component needs this.",
      "impact": "Minor performance impact. Component has too much responsibility."
    },
    {
      "finding_id": "CODE-028",
      "severity": "high",
      "category": "accessibility",
      "location": "src/components/PlayingScreen.jsx:604-619",
      "description": "Button has keyboard shortcuts but no visible labels for keyboard users",
      "code_snippet": "<button\n  onClick={() => setShowKeyboardHint(prev => !prev)}\n  title=\"Keyboard shortcuts\"\n  style={{...}}\n>\n  ‚å®\n</button>",
      "remediation": "Add aria-label=\"Toggle keyboard shortcuts help\". Consider showing shortcut hints on focus for screen reader users.",
      "impact": "Screen reader users cannot understand button purpose without visual context."
    },
    {
      "finding_id": "CODE-029",
      "severity": "medium",
      "category": "state_management",
      "location": "src/hooks/useGameState.js:116-214",
      "description": "handleRoundSubmit has complex state updates - could use immer for immutability",
      "code_snippet": "const newResults = [...team.results, result];\nconst newScore = team.score + netPoints;\nconst finalState = {\n  ...gameState,\n  phase: 'debrief',\n  currentRound: currentRound + 1,\n  team: {\n    ...team,\n    score: newScore,\n    results: newResults\n  }\n};",
      "remediation": "Use Immer library for immutable updates. Reduces spread operator complexity and prevents mutation bugs.",
      "impact": "Risk of shallow copy bugs. Harder to maintain complex nested updates."
    },
    {
      "finding_id": "CODE-030",
      "severity": "low",
      "category": "code_smells",
      "location": "src/services/leaderboard.js:139-141",
      "description": "Magic number 100 for record limit - should be constant",
      "code_snippet": "// Keep only last 100 games to prevent storage bloat\nconst trimmed = records.slice(-100);",
      "remediation": "Define const MAX_STORED_GAMES = 100 at top of file. Document why this limit exists.",
      "impact": "Hard to understand and change limit. Magic number reduces code clarity."
    },
    {
      "finding_id": "CODE-031",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/services/leaderboard.js:143-162",
      "description": "Complex quota exceeded handling with multiple retry attempts - unclear behavior",
      "code_snippet": "try {\n  localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmed));\n} catch (quotaError) {\n  if (quotaError.name === 'QuotaExceededError' || ...) {\n    const reduced = trimmed.slice(-50);\n    try {\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(reduced));\n    } catch (retryError) {\n      const minimal = trimmed.slice(-10);\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(minimal));\n    }\n  }\n}",
      "remediation": "Extract to utility function handleStorageQuotaExceeded(). Add user notification about data truncation. Log metrics.",
      "impact": "Silent data loss. User unaware that old games are being deleted."
    },
    {
      "finding_id": "CODE-032",
      "severity": "low",
      "category": "documentation",
      "location": "src/services/gameState.js:1-187",
      "description": "Good comments present but missing high-level module documentation",
      "code_snippet": "/**\n * GAME STATE MANAGER\n * Handles mid-game state persistence to localStorage for crash recovery\n */",
      "remediation": "Add usage examples in comment. Document recovery flow. Add link to architecture docs if available.",
      "impact": "Minor - developers can understand from reading code but examples would help."
    },
    {
      "finding_id": "CODE-033",
      "severity": "high",
      "category": "security",
      "location": "src/services/firebase.js:413-414",
      "description": "User input sanitization happens after length check - potential XSS vector",
      "code_snippet": "const sanitizedClaimText = sanitizeInput(claimData.claimText || '', MAX_CLAIM_LENGTH);",
      "remediation": "Sanitize input BEFORE length check. Validate against XSS patterns. Consider using DOMPurify for HTML content.",
      "impact": "Potential stored XSS if sanitizeInput is insufficient. Security vulnerability."
    },
    {
      "finding_id": "CODE-034",
      "severity": "medium",
      "category": "performance",
      "location": "src/components/TeacherDashboard.jsx:372-396",
      "description": "useMemo recalculating filtered games on every dependency change - could be optimized",
      "code_snippet": "const filteredAndSortedGames = useMemo(() => {\n  let filtered = games;\n  if (gamesFilterDifficulty !== 'all') {\n    filtered = filtered.filter(g => g.difficulty === gamesFilterDifficulty);\n  }\n  const sorted = [...filtered].sort((a, b) => {...});\n  return sorted;\n}, [games, gamesFilterDifficulty, gamesSortBy]);",
      "remediation": "Split into separate useMemos: filteredGames and sortedGames. Reduce unnecessary recalculations.",
      "impact": "Unnecessary recalculations on every render. Performance degradation with large datasets."
    },
    {
      "finding_id": "CODE-035",
      "severity": "critical",
      "category": "error_handling",
      "location": "src/App.jsx:392-440",
      "description": "handleStartPrediction has no validation that claims exist before creating session",
      "code_snippet": "const handleStartPrediction = useCallback((prediction) => {\n  if (!pendingGameSettings) return;\n  // Validate claims exist before starting\n  if (!pendingGameSettings.claims?.length) {\n    logger.error('No claims available to start game');\n    setShowPrediction(false);\n    setPendingGameSettings(null);\n    return; // Silent failure\n  }",
      "remediation": "Show error toast to user. Don't silently fail. Validate claims in startGame before showing prediction modal.",
      "impact": "Poor UX - user sees nothing when game fails to start. Confusing behavior."
    },
    {
      "finding_id": "CODE-036",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/PlayingScreen.jsx:384-395",
      "description": "Complex ternary operations and conditionals in inline styles - hard to read",
      "code_snippet": "const confidencePreview = useMemo(() => {\n  const basePoints = {\n    1: { correct: 1, incorrect: -1 },\n    2: { correct: 3, incorrect: -3 },\n    3: { correct: 5, incorrect: -6 }\n  }[confidence];\n  const multiplier = DIFFICULTY_MULTIPLIERS[difficulty] || 1;\n  return {\n    ifCorrect: Math.round(basePoints.correct * multiplier),\n    ifWrong: -Math.round(Math.abs(basePoints.incorrect * multiplier))\n  };\n}, [confidence, difficulty]);",
      "remediation": "Extract to utility function getConfidencePreview(confidence, difficulty). Improve readability.",
      "impact": "Hard to understand calculation logic. Difficult to test."
    },
    {
      "finding_id": "CODE-037",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/ClaimCard.jsx:83-104",
      "description": "Nested ternary operators for source badge styling - hard to read",
      "code_snippet": "background:\n  claim.source === 'student-contributed'\n    ? 'rgba(251, 191, 36, 0.2)'\n    : claim.source === 'ai-generated'\n    ? 'rgba(167, 139, 250, 0.2)'\n    : 'rgba(52, 211, 153, 0.2)',",
      "remediation": "Extract to function getSourceBadgeStyles(source) returning style object. Improves readability.",
      "impact": "Minor readability issue. Hard to maintain if more sources added."
    },
    {
      "finding_id": "CODE-038",
      "severity": "medium",
      "category": "testing",
      "location": "src/utils/game.js:26-139",
      "description": "Complex claim selection logic with no visible unit tests for edge cases",
      "code_snippet": "export async function selectClaimsByDifficulty(difficulty, count, subjects = [], ...) {\n  // Complex filtering, shuffling, fallback logic\n  // No tests visible for: empty pool, insufficient claims, subject filtering\n}",
      "remediation": "Add comprehensive unit tests covering: empty database, single claim, insufficient claims, all difficulties, subject filtering edge cases.",
      "impact": "High risk of bugs in game-critical functionality. No confidence in correctness."
    },
    {
      "finding_id": "CODE-039",
      "severity": "high",
      "category": "state_management",
      "location": "src/components/TeacherDashboard.jsx:66-105",
      "description": "Excessive state variables (20+) with complex interdependencies",
      "code_snippet": "const [activeTab, setActiveTab] = useState('overview');\nconst [reflections, setReflections] = useState([]);\nconst [games, setGames] = useState([]);\nconst [pendingClaims, setPendingClaims] = useState([]);\nconst [reviewedClaims, setReviewedClaims] = useState([]);\nconst [classAchievements, setClassAchievements] = useState([]);\nconst [loading, setLoading] = useState(true);\nconst [error, setError] = useState(null);\n// 15+ more state variables",
      "remediation": "Use useReducer for dashboard state. Group related state (UI state, data state, loading state). Extract to custom hook useDashboardState().",
      "impact": "Extremely difficult to manage state. High risk of inconsistent state. Poor performance from excessive re-renders."
    },
    {
      "finding_id": "CODE-040",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/components/TeacherDashboard.jsx:215-243",
      "description": "handleSaveSettings has timeout cleanup but no error recovery",
      "code_snippet": "const handleSaveSettings = async () => {\n  try {\n    const result = await FirebaseBackend.saveClassSettings(classSettings);\n    if (result.success) {\n      setSettingsSaved(true);\n      settingsTimeoutRef.current = setTimeout(() => {...}, 2000);\n    } else {\n      setError(result.error || 'Failed to save settings'); // Generic error\n    }\n  } catch (e) {\n    setError('Failed to save settings'); // No retry, no specifics\n  }\n}",
      "remediation": "Add retry mechanism. Show specific error messages. Allow user to retry failed save.",
      "impact": "Poor UX when saves fail. No recovery path for transient failures."
    },
    {
      "finding_id": "CODE-041",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/TeacherDashboard.jsx:26-50",
      "description": "Utility functions defined inside component file - should be external",
      "code_snippet": "function exportToCSV(data, filename) {\n  // CSV export logic\n}\n\nfunction formatDate(timestamp) {\n  // Date formatting logic\n}",
      "remediation": "Move to utils/export.js and utils/date.js. Make them reusable across components.",
      "impact": "Code duplication risk. Not reusable. Harder to test."
    },
    {
      "finding_id": "CODE-042",
      "severity": "medium",
      "category": "performance",
      "location": "src/components/TeacherDashboard.jsx:413-481",
      "description": "Inline CSS in style tag - should use CSS modules or styled-components",
      "code_snippet": "<style>{`\n  @media (max-width: 1366px) and (max-height: 768px) {\n    .viewport-container {\n      padding: 0.5rem !important;\n      // 60+ lines of CSS\n    }\n  }\n`}</style>",
      "remediation": "Extract to CSS module or use className approach. Avoid inline style tags for maintainability.",
      "impact": "Hard to maintain CSS. No IDE support. Increases component size."
    },
    {
      "finding_id": "CODE-043",
      "severity": "high",
      "category": "type_safety",
      "location": "src/components/PlayingScreen.jsx:787-840",
      "description": "PropTypes defined but many are not validated at runtime in development",
      "code_snippet": "PlayingScreen.propTypes = {\n  claim: PropTypes.shape({...}).isRequired,\n  round: PropTypes.number.isRequired,\n  totalRounds: PropTypes.number.isRequired,\n  // ...\n};",
      "remediation": "Ensure PropTypes validation is enabled in development build. Consider TypeScript for compile-time validation. Add runtime validation for critical props.",
      "impact": "PropTypes provide limited protection. Runtime errors still possible."
    },
    {
      "finding_id": "CODE-044",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/services/firebase.js:774-838",
      "description": "Complex listener management with manual ID tracking - could use Map",
      "code_snippet": "_listeners: {},\n_nextListenerId: 0,\n\nsubscribeToPendingClaims(callback, classFilter = null) {\n  const listenerId = this._nextListenerId++;\n  const listenerKey = `pendingClaims_${listenerId}`;\n  this._listeners[listenerKey] = unsubscribe;\n  return () => {\n    if (this._listeners[listenerKey]) {\n      this._listeners[listenerKey]();\n      delete this._listeners[listenerKey];\n    }\n  };\n}",
      "remediation": "Use Map for listeners. Use WeakMap if listeners hold component references. Simplify ID generation with Symbol().",
      "impact": "Potential memory leaks if cleanup not called. Complex manual ID management."
    },
    {
      "finding_id": "CODE-045",
      "severity": "low",
      "category": "documentation",
      "location": "src/utils/game.js:189-214",
      "description": "getHintContent has magic strings for hint types - should be constants",
      "code_snippet": "export function getHintContent(claim, hintType) {\n  switch(hintType) {\n    case 'source-hint':\n    case 'error-hint':\n    case 'subject-hint':\n    default:\n  }\n}",
      "remediation": "Import HINT_TYPES constants. Use HINT_TYPES.SOURCE_HINT etc. Document expected hintType values in JSDoc.",
      "impact": "Typo in hint type string causes silent failure. Hard to refactor hint types."
    },
    {
      "finding_id": "CODE-046",
      "severity": "high",
      "category": "error_handling",
      "location": "src/components/SetupScreen.jsx:327-390",
      "description": "startGame async function with try-finally but errors not shown to user",
      "code_snippet": "const startGame = useCallback(async (settings) => {\n  setIsPreparingGame(true);\n  try {\n    const selectedClaims = selectClaimsByDifficulty(...);\n    // Could throw\n  } finally {\n    setIsPreparingGame(false); // Always clears loading\n  }\n  // No catch block - errors silently fail\n}, []);",
      "remediation": "Add catch block. Show error toast to user. Handle specific error types (no claims, Firebase down, etc.).",
      "impact": "Silent failures confuse users. No feedback when game creation fails."
    },
    {
      "finding_id": "CODE-047",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/DebriefScreen.jsx:18",
      "description": "Unused props with underscore prefix - should remove if truly unused",
      "code_snippet": "export function DebriefScreen({ team, claims, onRestart, difficulty: _difficulty, teamAvatar: _teamAvatar }) {",
      "remediation": "Remove _difficulty and _teamAvatar from props if not needed. Or use them for display.",
      "impact": "Confusing prop signature. Unclear if props are needed."
    },
    {
      "finding_id": "CODE-048",
      "severity": "medium",
      "category": "performance",
      "location": "src/components/DebriefScreen.jsx:175-176",
      "description": "Duplicate calculation of aiCatchRate and aiCorrectCount - could be memoized together",
      "code_snippet": "const aiClaims = claims.filter((c) => c.source === 'ai-generated');\nconst aiClaimResults = team.results.filter((r) => {\n  const claim = claims.find((c) => c.id === r.claimId);\n  return claim?.source === 'ai-generated';\n});\nconst aiCorrectCount = aiClaimResults.filter((r) => r.correct).length;\nconst aiCatchRate = aiClaims.length > 0 ? Math.round((aiCorrectCount / aiClaims.length) * 100) : 0;",
      "remediation": "Combine into single useMemo calculating all AI-related stats at once. Avoid multiple array iterations.",
      "impact": "Inefficient array filtering. Multiple passes over same data."
    },
    {
      "finding_id": "CODE-049",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/VotingSection.jsx:1-230",
      "description": "Component exports both named and default export - inconsistent pattern",
      "code_snippet": "export const VotingSection = memo(VotingSectionComponent);\nexport default VotingSection;",
      "remediation": "Pick one export pattern. Prefer named exports for tree-shaking benefits. Document export strategy.",
      "impact": "Minor - inconsistent import patterns across codebase. Confusing for developers."
    },
    {
      "finding_id": "CODE-050",
      "severity": "medium",
      "category": "accessibility",
      "location": "src/components/TeacherDashboard.jsx:798-828",
      "description": "Tab navigation uses style-based active state without ARIA attributes",
      "code_snippet": "<button\n  key={tab.id}\n  onClick={() => setActiveTab(tab.id)}\n  style={{\n    background: activeTab === tab.id ? 'var(--accent-cyan)' : 'var(--bg-card)',\n    // No aria-selected or role=\"tab\"\n  }}\n>",
      "remediation": "Add role=\"tablist\" to container, role=\"tab\" to buttons, aria-selected={activeTab === tab.id}, aria-controls pointing to tab panels.",
      "impact": "Screen reader users cannot properly navigate tabs. Fails WCAG 2.1 AA."
    },
    {
      "finding_id": "CODE-051",
      "severity": "high",
      "category": "error_handling",
      "location": "src/services/firebase.js:913-944",
      "description": "updateActiveSession fails silently on error - no retry or notification",
      "code_snippet": "async updateActiveSession(sessionId, gameData) {\n  try {\n    await setDoc(sessionDoc, {...}, { merge: true });\n    return true;\n  } catch (e) {\n    logger.warn('Failed to update active session:', e);\n    return false; // Silent failure\n  }\n}",
      "remediation": "Implement retry logic for transient failures. Use offline queue for persistence. Notify user if session sync fails.",
      "impact": "Live leaderboard shows stale data. Poor multiplayer experience."
    },
    {
      "finding_id": "CODE-052",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/PlayingScreen.jsx:551-585",
      "description": "Complex inline calculation for timer display with IIFE - hard to test",
      "code_snippet": "{!showResult && timeRemaining !== null && (() => {\n  const elapsed = totalTimeAllowed - timeRemaining;\n  const pct = elapsed / totalTimeAllowed;\n  const inBonusZone = pct <= 0.50 && timeRemaining > 10;\n  // 30+ lines of logic\n  return (<div>...</div>);\n})()}",
      "remediation": "Extract to separate component TimerDisplay or helper function getTimerDisplay(). Add unit tests.",
      "impact": "Untestable inline logic. Hard to maintain and debug."
    },
    {
      "finding_id": "CODE-053",
      "severity": "low",
      "category": "code_smells",
      "location": "src/services/leaderboard.js:122",
      "description": "Generating IDs with Math.random - should use crypto.randomUUID or uuid library",
      "code_snippet": "id: `game_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`,",
      "remediation": "Use crypto.randomUUID() for better uniqueness. Add collision detection. Document ID format.",
      "impact": "Potential ID collisions. Not cryptographically secure (though not needed here)."
    },
    {
      "finding_id": "CODE-054",
      "severity": "medium",
      "category": "testing",
      "location": "src/hooks/useGameState.js:1-345",
      "description": "Complex custom hook with no visible tests - high risk code",
      "code_snippet": "export function useGameState() {\n  // Game state management logic\n  // No tests found\n}",
      "remediation": "Add comprehensive React Hook tests using @testing-library/react-hooks. Test state transitions, edge cases, error scenarios.",
      "impact": "High risk of regression bugs. No confidence in correctness of game logic."
    },
    {
      "finding_id": "CODE-055",
      "severity": "high",
      "category": "state_management",
      "location": "src/components/PlayingScreen.jsx:56-76",
      "description": "State management scattered across 15+ useState calls - should use reducer",
      "code_snippet": "const [confidence, setConfidence] = useState(2);\nconst [verdict, setVerdict] = useState(null);\nconst [reasoning, setReasoning] = useState('');\nconst [showResult, setShowResult] = useState(false);\nconst [resultData, setResultData] = useState(null);\nconst [activeHint, setActiveHint] = useState(null);\nconst [usedHints, setUsedHints] = useState([]);\nconst [hintCostTotal, setHintCostTotal] = useState(0);\n// 8+ more",
      "remediation": "Use useReducer with actions: SET_VERDICT, SET_CONFIDENCE, SUBMIT_ANSWER, SHOW_RESULT, RESET_ROUND. Consolidate related state.",
      "impact": "Extremely difficult to manage state transitions. High bug risk. Poor performance from multiple re-renders."
    },
    {
      "finding_id": "CODE-056",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/services/firebase.js:1242-1320",
      "description": "exportClassData has no pagination - could timeout with large datasets",
      "code_snippet": "async exportClassData(classFilter = null, days = 30) {\n  const q = query(\n    gamesRef,\n    where('classCode', '==', filterClass),\n    orderBy('createdAt', 'desc'),\n    limit(500) // Hard limit\n  );\n  // No pagination support\n}",
      "remediation": "Add pagination support. Stream data in chunks. Show progress indicator for large exports.",
      "impact": "Poor performance with large datasets. Potential timeout errors. Bad UX."
    },
    {
      "finding_id": "CODE-057",
      "severity": "low",
      "category": "documentation",
      "location": "src/components/ClaimCard.jsx:1-226",
      "description": "Well-documented PropTypes but no component usage examples",
      "code_snippet": "// PropTypes validation\nClaimCardComponent.propTypes = {...};",
      "remediation": "Add usage example in JSDoc comment showing typical props. Document visual variants.",
      "impact": "Minor - developers need to find usage examples in other files."
    },
    {
      "finding_id": "CODE-058",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/App.jsx:1-1139",
      "description": "App.jsx is 1139 lines - too large for maintainability",
      "code_snippet": "export function App() {\n  // 1139 lines handling: routing, game state, Firebase, sound, analytics, etc.\n}",
      "remediation": "Extract components: GameSetup, GamePlay, GameDebrief. Extract hooks: useFirebaseSession, useGameLifecycle. Use React Router.",
      "impact": "Extremely difficult to maintain. Long file load times. Hard to understand flow."
    },
    {
      "finding_id": "CODE-059",
      "severity": "high",
      "category": "performance",
      "location": "src/App.jsx:86-91",
      "description": "useEffect runs on every mount calling GameStateManager.getSummary synchronously",
      "code_snippet": "useEffect(() => {\n  const summary = GameStateManager.getSummary();\n  if (summary) {\n    setSavedGameSummary(summary);\n  }\n}, []); // Only on mount but synchronous localStorage read",
      "remediation": "Consider lazy loading saved game summary only when needed. Use Suspense boundary.",
      "impact": "Blocks initial render with synchronous localStorage read. Poor startup performance."
    },
    {
      "finding_id": "CODE-060",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/utils/helpers.js:1-15",
      "description": "Re-export module structure makes error messages unclear",
      "code_snippet": "export { shuffleArray, getRandomItem, ... } from './generic';\nexport { selectClaimsByDifficulty, ... } from './game';",
      "remediation": "Document in JSDoc that this is a facade module. Consider direct imports for better error messages.",
      "impact": "Stack traces show helpers.js instead of actual implementation file. Harder debugging."
    },
    {
      "finding_id": "CODE-061",
      "severity": "low",
      "category": "code_smells",
      "location": "src/services/gameState.js:103-104",
      "description": "Magic number 24 hours for max saved game age - should be constant",
      "code_snippet": "const MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours",
      "remediation": "Move to top-level const MAX_SAVED_GAME_AGE_MS with clear naming. Document why 24 hours.",
      "impact": "Minor - hard to find and change the limit if product requirements change."
    },
    {
      "finding_id": "CODE-062",
      "severity": "critical",
      "category": "error_handling",
      "location": "src/App.jsx:533-556",
      "description": "PlayerProfile.recordGame could fail but no error handling - data loss risk",
      "code_snippet": "PlayerProfile.recordGame({\n  finalScore: finalScore,\n  rounds: newResults,\n  // ...\n}); // No try-catch, no error handling",
      "remediation": "Wrap in try-catch. Show warning to user if profile update fails. Implement offline queue for profile updates.",
      "impact": "Silent data loss for solo player statistics. Poor user experience."
    },
    {
      "finding_id": "CODE-063",
      "severity": "medium",
      "category": "performance",
      "location": "src/components/DebriefScreen.jsx:536-582",
      "description": "Mapping over AI_ERROR_PATTERNS array inline - could be memoized",
      "code_snippet": "{AI_ERROR_PATTERNS.map((pattern, i) => (\n  <div key={i}>\n    // Pattern display\n  </div>\n))}",
      "remediation": "useMemo for pattern rendering if AI_ERROR_PATTERNS is large. Or move to separate component if static.",
      "impact": "Minor performance impact. Re-renders even when patterns don't change."
    },
    {
      "finding_id": "CODE-064",
      "severity": "high",
      "category": "type_safety",
      "location": "src/utils/scoring.js:58",
      "description": "Object property access without null check - potential runtime error",
      "code_snippet": "const basePoints = POINTS_MATRIX[confidence][correct ? 'correct' : 'incorrect'];",
      "remediation": "Add null/undefined check for POINTS_MATRIX[confidence]. Use optional chaining or defensive coding.",
      "impact": "Runtime error if POINTS_MATRIX structure changes or confidence is invalid."
    },
    {
      "finding_id": "CODE-065",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/TeacherDashboard.jsx:1012-1078",
      "description": "Inline game card rendering - should be extracted to component",
      "code_snippet": "{filteredAndSortedGames.slice(0, 20).map((game, i) => (\n  <div key={game.id || i}>\n    // 60+ lines of JSX\n  </div>\n))}",
      "remediation": "Extract to GameCard component. Improves readability and allows memoization.",
      "impact": "Hard to read. Can't memoize individual cards. Poor performance with large lists."
    },
    {
      "finding_id": "CODE-066",
      "severity": "low",
      "category": "accessibility",
      "location": "src/components/SetupScreen.jsx:488-507",
      "description": "Avatar selection buttons using emoji without proper ARIA labels",
      "code_snippet": "<button\n  onClick={() => setSelectedAvatar(avatar)}\n  title={avatar.name}\n  aria-label={`Select ${avatar.name} as team mascot`}\n  style={{...}}\n>\n  <span role=\"img\" aria-label={avatar.name}>{avatar.emoji}</span>\n</button>",
      "remediation": "Good aria-label on button. Consider adding aria-describedby for additional context.",
      "impact": "Actually well-implemented. Minor improvement possible with describedby."
    },
    {
      "finding_id": "CODE-067",
      "severity": "medium",
      "category": "testing",
      "location": "src/services/firebase.js:1-1427",
      "description": "Large Firebase service file (1427 lines) with complex async operations - needs integration tests",
      "code_snippet": "export const FirebaseBackend = {\n  // 1427 lines of Firebase operations\n  // No tests visible\n}",
      "remediation": "Add integration tests with Firebase emulator. Test key flows: save, load, subscriptions, transactions. Mock Firestore for unit tests.",
      "impact": "High risk of Firebase-related bugs. No confidence in correctness."
    },
    {
      "finding_id": "CODE-068",
      "severity": "high",
      "category": "error_handling",
      "location": "src/components/TeacherDashboard.jsx:174-184",
      "description": "Real-time listener setup has no error recovery or reconnection logic",
      "code_snippet": "useEffect(() => {\n  if (!isOnline || !FirebaseBackend.initialized) return;\n  const unsubscribe = FirebaseBackend.subscribeToPendingClaims((claims) => {\n    setPendingClaims(claims);\n  });\n  return () => unsubscribe();\n}, [isOnline]);",
      "remediation": "Add error callback to subscription. Implement reconnection logic. Show connection status to user.",
      "impact": "Real-time updates stop working on error with no recovery. Poor UX in unreliable network conditions."
    },
    {
      "finding_id": "CODE-069",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/components/SetupScreen.jsx:69-83",
      "description": "useEffect for async operations could cause race conditions",
      "code_snippet": "useEffect(() => {\n  if (selectedSubjects.length === 0) {\n    setSubjectClaimStats(null);\n    return;\n  }\n  getUnseenClaimStats([], selectedSubjects)\n    .then(stats => setSubjectClaimStats(stats))\n    .catch(() => setSubjectClaimStats(null));\n}, [selectedSubjects.length]);",
      "remediation": "Use AbortController to cancel pending requests. Add loading state. Use dependency array correctly (should include selectedSubjects, not just length).",
      "impact": "Race condition when subjects change quickly. Stale state updates. Memory leaks from unmounted component updates."
    },
    {
      "finding_id": "CODE-070",
      "severity": "low",
      "category": "documentation",
      "location": "src/services/firebase.js:773-839",
      "description": "Complex listener pattern not well documented - unclear cleanup guarantees",
      "code_snippet": "// FIXED: Store listener with unique ID to support multiple subscribers\nconst listenerId = this._nextListenerId++;\nconst listenerKey = `pendingClaims_${listenerId}`;\nthis._listeners[listenerKey] = unsubscribe;",
      "remediation": "Add detailed JSDoc explaining listener lifecycle. Document when cleanup is guaranteed vs not. Add example usage.",
      "impact": "Developers may misuse listeners leading to memory leaks. Complex pattern hard to understand."
    },
    {
      "finding_id": "CODE-071",
      "severity": "high",
      "category": "state_management",
      "location": "src/components/TeacherDashboard.jsx:245-249",
      "description": "Direct state mutation of nested object - potential React reconciliation bugs",
      "code_snippet": "const updateSetting = (key, value) => {\n  setClassSettings(prev => ({ ...prev, [key]: value }));\n  setSettingsSaved(false);\n};",
      "remediation": "While shallow spread is used, document that classSettings values should be primitives. Add deep clone for nested values if needed.",
      "impact": "Risk of shared reference bugs if values are objects. State updates may not trigger re-renders correctly."
    },
    {
      "finding_id": "CODE-072",
      "severity": "medium",
      "category": "performance",
      "location": "src/components/PlayingScreen.jsx:122-166",
      "description": "useCallback with complex dependencies may cause excessive re-creation",
      "code_snippet": "const handleKeyDown = useCallback((e) => {\n  // Keyboard handler logic\n}, [showResult, verdict]);",
      "remediation": "Review if memoization is necessary. Consider using refs for frequently changing values. Profile re-render performance.",
      "impact": "Callback recreated on every verdict/result change. Potential performance impact on low-end devices."
    },
    {
      "finding_id": "CODE-073",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/TeacherDashboard.jsx:15",
      "description": "Importing getSubjects from claims.js instead of dedicated file",
      "code_snippet": "import { getSubjects } from '../data/claims';",
      "remediation": "Already fixed in newer code - use '../data/subjects'. Ensure consistency across codebase.",
      "impact": "Minor - coupling to claims module when subjects should be independent."
    },
    {
      "finding_id": "CODE-074",
      "severity": "critical",
      "category": "error_handling",
      "location": "src/App.jsx:533-612",
      "description": "Multiple Firebase operations without error boundaries - batch failure not handled",
      "code_snippet": "// Save to leaderboard\nLeaderboardManager.save(gameRecord);\n// Save to Firebase\nFirebaseBackend.save(gameRecord).catch((e) => { logger.warn('Firebase save failed:', e); });\n// Record to player profile\nPlayerProfile.recordGame({...});\n// Update player identity\nPlayerProfile.updateIdentity(...);\n// Share achievements\nFirebaseBackend.shareAchievement(...).catch(...);",
      "remediation": "Use Promise.allSettled to handle partial failures. Notify user of any failures. Implement offline queue for critical operations.",
      "impact": "Silent partial failures. User data may be inconsistent across systems."
    },
    {
      "finding_id": "CODE-075",
      "severity": "medium",
      "category": "code_smells",
      "location": "src/utils/game.js:80-104",
      "description": "Complex nested logic in selectClaimsByDifficulty for mixed difficulty - hard to test",
      "code_snippet": "if (difficulty === 'mixed') {\n  const easyCount = Math.ceil(count * 0.3);\n  const medCount = Math.ceil(count * 0.4);\n  const hardCount = count - easyCount - medCount;\n  // Complex distribution logic\n}",
      "remediation": "Extract to function calculateDifficultyDistribution(count). Add unit tests for different count values.",
      "impact": "Hard to verify distribution is correct. Difficult to adjust percentages."
    },
    {
      "finding_id": "CODE-076",
      "severity": "low",
      "category": "accessibility",
      "location": "src/components/PlayingScreen.jsx:551-585",
      "description": "Timer has good aria-live but updates every second - could overwhelm screen readers",
      "code_snippet": "<div\n  role=\"timer\"\n  aria-live={timeRemaining <= 10 ? 'assertive' : 'off'}\n  aria-atomic=\"true\"\n>",
      "remediation": "Good implementation - only announces when critical (<=10s). Consider announcing at 30s, 10s, 5s intervals instead of every second.",
      "impact": "Minor - current implementation is acceptable but could be optimized."
    },
    {
      "finding_id": "CODE-077",
      "severity": "medium",
      "category": "testing",
      "location": "src/components/DebriefScreen.jsx:71-97",
      "description": "Complex async callback handleSaveReflection with no visible tests",
      "code_snippet": "const handleSaveReflection = useCallback(async () => {\n  // Complex reflection data assembly\n  const saved = await FirebaseBackend.saveReflection(reflectionData);\n  // State updates\n}, [team, selectedReflection, reflectionResponse, reflectionPrompt, finalScore, reflectionSaved]);",
      "remediation": "Add component tests using @testing-library/react. Mock Firebase. Test success and failure paths.",
      "impact": "Untested critical user data submission. High risk of regression bugs."
    },
    {
      "finding_id": "CODE-078",
      "severity": "high",
      "category": "state_management",
      "location": "src/App.jsx:156-165",
      "description": "useEffect dependency array uses object properties instead of primitives - causes issues",
      "code_snippet": "}, [\n  sessionId,\n  gameState.phase,\n  gameState.currentRound,\n  gameState.team.score,\n  gameState.team.name,\n  gameState.team.avatar?.emoji,\n  gameState.totalRounds,\n  gameState.team.results.length\n]);",
      "remediation": "Good - already using primitive values. Document why this pattern is used (comment explains).",
      "impact": "Already fixed - this is actually good code. No issue."
    },
    {
      "finding_id": "CODE-079",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/PlayingScreen.jsx:14",
      "description": "Large destructured import from constants - could import specific items",
      "code_snippet": "import { DIFFICULTY_CONFIG, DIFFICULTY_BG_COLORS, DIFFICULTY_MULTIPLIERS, HINT_TYPES, ENCOURAGEMENTS, ANTI_CHEAT } from '../data/constants';",
      "remediation": "Fine for now. Consider splitting constants.js if it grows too large. Group related constants into sub-modules.",
      "impact": "Minor - slight bundle size increase but tree-shaking should handle it."
    },
    {
      "finding_id": "CODE-080",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/services/firebase.js:812-821",
      "description": "onSnapshot error handler only logs - doesn't attempt recovery or notify user",
      "code_snippet": "const unsubscribe = onSnapshot(q, (snapshot) => {\n  const claims = snapshot.docs.map(...);\n  callback(claims);\n}, (error) => {\n  logger.warn('Real-time claims subscription error:', error);\n});",
      "remediation": "Implement retry logic. Notify user of connection issues. Fall back to polling if real-time fails.",
      "impact": "Real-time updates stop working on error. User unaware of stale data."
    },
    {
      "finding_id": "CODE-081",
      "severity": "medium",
      "category": "performance",
      "location": "src/components/DebriefScreen.jsx:176-514",
      "description": "Large JSX return block (338 lines) - should be split into sub-components",
      "code_snippet": "return (\n  <div className=\"viewport-container\">\n    {/* 338 lines of JSX */}\n  </div>\n);",
      "remediation": "Extract components: FinalScoreDisplay, StatsGrid, AchievementsList, RoundBreakdown, ReflectionForm.",
      "impact": "Hard to read and maintain. Poor component composition. Difficult to test."
    },
    {
      "finding_id": "CODE-082",
      "severity": "low",
      "category": "documentation",
      "location": "src/hooks/useGameState.js:311-344",
      "description": "Good migration example comment but useGameState hook not actually used in App.jsx",
      "code_snippet": "/**\n * Example migration from App.jsx:\n * // Shows how to use this hook\n */",
      "remediation": "Remove outdated example or update App.jsx to actually use this hook. Clarify hook status.",
      "impact": "Minor - confusing documentation that doesn't match reality."
    },
    {
      "finding_id": "CODE-083",
      "severity": "high",
      "category": "code_smells",
      "location": "src/services/firebase.js:1-1427",
      "description": "Extremely large service file (1427 lines) violates Single Responsibility Principle",
      "code_snippet": "export const FirebaseBackend = {\n  // Handles: init, save, leaderboards, claims, reflections, sessions, settings, seen claims, export, achievements, listeners\n}",
      "remediation": "Split into modules: FirebaseAuth, FirebaseLeaderboard, FirebaseClaims, FirebaseReflections, FirebaseSettings, FirebaseExport.",
      "impact": "Extremely difficult to maintain. Hard to test. Poor code organization."
    },
    {
      "finding_id": "CODE-084",
      "severity": "medium",
      "category": "error_handling",
      "location": "src/components/PlayingScreen.jsx:98-119",
      "description": "useGameIntegrity hook used but integrity violations just log warnings",
      "code_snippet": "const integrity = useGameIntegrity(\n  !showResult,\n  (switchCount) => {\n    setTabSwitchWarning(switchCount);\n    setForfeitAcknowledged(false);\n    SoundManager.play('incorrect');\n  },\n  () => {\n    // Auto-forfeit logic\n  }\n);",
      "remediation": "Good implementation. Consider logging to analytics for teacher insights. Add test coverage.",
      "impact": "Actually well-implemented. Minor improvement: track patterns for analytics."
    },
    {
      "finding_id": "CODE-085",
      "severity": "low",
      "category": "code_smells",
      "location": "src/components/ClaimCard.jsx:6",
      "description": "memo used but no performance profiling to justify - premature optimization",
      "code_snippet": "export const ClaimCard = memo(ClaimCardComponent);",
      "remediation": "Keep memo if profiling shows benefit. Otherwise remove. Document why memoization is needed.",
      "impact": "Minor - unnecessary complexity if not providing real benefit."
    },
    {
      "finding_id": "CODE-086",
      "severity": "medium",
      "category": "best_practices",
      "location": "src/App.jsx:283-295",
      "description": "beforeunload event handler returns string - deprecated pattern",
      "code_snippet": "const handleBeforeUnload = (e) => {\n  if (gameState.phase === 'playing') {\n    e.preventDefault();\n    e.returnValue = 'You have an active game...';\n    return e.returnValue;\n  }\n};",
      "remediation": "Modern browsers ignore custom messages. Just call e.preventDefault(). Document that custom message won't show.",
      "impact": "Minor - code works but message not displayed in modern browsers."
    },
    {
      "finding_id": "CODE-087",
      "severity": "low",
      "category": "accessibility",
      "location": "src/components/VotingSection.jsx:191-193",
      "description": "Submit button disabled state good but no aria-disabled for assistive tech",
      "code_snippet": "<Button onClick={onSubmit} fullWidth disabled={!verdict || disabled}>\n  {teamAvatar?.emoji || '‚úì'} Submit Answer\n</Button>",
      "remediation": "Add aria-disabled={!verdict || disabled} for better AT support. Add aria-describedby explaining why disabled.",
      "impact": "Minor - disabled attribute usually sufficient but aria-disabled more semantic."
    }
  ],
  "recommendations": {
    "immediate_actions": [
      "Add error boundaries to critical components (App, PlayingScreen, TeacherDashboard)",
      "Implement proper error handling for all Firebase operations with user notifications",
      "Add try-catch blocks to async functions like selectClaimsByDifficulty and startGame",
      "Fix race condition in PlayingScreen between timer and manual submission",
      "Add validation for all calculatePoints parameters",
      "Implement retry logic for critical Firebase operations",
      "Add comprehensive error logging to error tracking service",
      "Fix memory leaks from missing timeout cleanup"
    ],
    "short_term": [
      "Refactor large components: split PlayingScreen (841 lines), TeacherDashboard (1870 lines), App (1139 lines)",
      "Consolidate state management using useReducer for complex state",
      "Extract business logic from components to services/utils",
      "Add unit tests for critical functions (selectClaimsByDifficulty, calculatePoints, handleRoundSubmit)",
      "Implement proper TypeScript or enhance JSDoc with runtime validation",
      "Add integration tests for Firebase operations using emulator",
      "Document complex algorithms and state management patterns"
    ],
    "long_term": [
      "Consider migrating to TypeScript for full type safety",
      "Implement proper state management library (Zustand/Redux Toolkit) for global state",
      "Add comprehensive test coverage (target 80%+)",
      "Set up proper error tracking service (Sentry/LogRocket)",
      "Implement code splitting and lazy loading for better performance",
      "Add proper monitoring and analytics for production issues",
      "Create architecture documentation and coding standards",
      "Implement server-side aggregation for Firebase queries to reduce client load"
    ]
  },
  "metrics": {
    "files_analyzed": 15,
    "total_lines_of_code": "~10000",
    "average_component_size": "~500 lines",
    "largest_components": [
      "TeacherDashboard.jsx: 1870 lines",
      "firebase.js: 1427 lines",
      "App.jsx: 1139 lines",
      "PlayingScreen.jsx: 841 lines"
    ],
    "components_over_500_lines": 4,
    "functions_over_50_lines": 12,
    "test_coverage": "Partial - test files exist but coverage unknown",
    "type_safety": "PropTypes used - no TypeScript"
  }
}
